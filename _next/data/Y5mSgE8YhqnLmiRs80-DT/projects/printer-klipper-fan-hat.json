{"pageProps":{"post":{"slug":"printer-klipper-fan-hat","related":[],"external":["https://github.com/timmit99/Klipper-Expander"],"title":"Klipper Fan Hat","heading":"Creating a Printed Circuit Board to control fans in Klipper","date":"2023-03-21T00:00:00.000Z","preview":"/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-hero.jpg","author":{"name":"Mike Thomas","picture":"/assets/authors/mike.jpg"},"description":"Making a Raspberry Pi Hat based on the Klipper Expander, to control additional fans using the Pi as a Secondary MCU in Klipper Firmware, the Klipper Fan Hat.","tags":["Printed Circuit Board","Raspberry Pi"],"categories":[],"keywords":["Klipper","Klipper Expander","Klipper Fan Hat"],"promoted":false,"content":"\n# Table of contents\n\n# What is the Klipper Fan Hat?\n\nI wanted to explore making a Raspberry Pi Hat based on [Tim Abraham's Klipper Expander](https://github.com/timmit99/Klipper-Expander) to control additional fans using the [Raspberry Pi as a Secondary MCU in Klipper Firmware](https://www.klipper3d.org/RPi_microcontroller.html).\n\n# What about the Klipper Expander?\n\nThe Klipper Expander is designed to add 4 additional Mosfet outputs, 2 thermistor inputs, a Neopixel output, a GPIO Header and an I2C header that can be added as a secondary Klipper MCU. The Klipper Fan Hat is supposed to be a re-imagining of this, which can be attached on top of the Raspberry Pi that is used as the Klipper Host.\n\nThe Klipper Fan Hat is not supposed to be a replacement for the Klipper Expander, the Klipper expander can handle more current as it has wider PCB tracks than this PCB. Therefore the Klipper Fan Hat should only be used for lower current devices such as fans. Also, the Klipper Fan Hat does not support Neopixels due to space constraints of fitting it within the footprint of a Raspberry Pi Hat.\n\nKlipper Fan Hat features:\n\n- SKR Pico compatible input for powering the Pi and Serial communication\n- 5 Mosfet outputs (with 2 pin JST-XH connectors standard on most fans used on 3D printers)\n- Voltage selector jumpers to power each fan from either 5V or VCC supplied by screw terminal\n- I2C and 1-Wire and SPI headers for connecting accesories to the Raspberry Pi\n- ~2 thermistor inputs~ (removed, see [Testing Section](#testing) to find out why)\n- 2 headers connected to General Purpose GPIO pins for accesories such as Filament Run Out Sensors\n\n# Printed Circuit Board\n\nThe PCB (printed circuit board) was designed in [KiCad 7](https://www.kicad.org/) and I have created a [repository on my GitHub](https://github.com/mikepthomas/Klipper-Fan-Hat) with the design files and Gerber files.\n\nTwo versions of the board have been produced:\n\n- [Pre-release Version 1](https://github.com/mikepthomas/Klipper-Fan-Hat/releases/tag/v1.0)\n- [Release Version 2](https://github.com/mikepthomas/Klipper-Fan-Hat/releases/tag/v2.0)\n\nI used [PCBWay](https://pcbway.com/) to produce the PCBs.\n\n![3D render of the front of the Klipper Fan Hat](/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-front.jpg)\n\nAlthough currently untested, the main branch contains the updated version of the board, V2, with a few revisions to fix some bugs that were found when testing the first version of the board.\n\n![3D render of the back of the Klipper Fan Hat](/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-back.jpg)\n\n# Parts Required\n\nThe reference numbers in the notes field refer to the parts required marked on the silkscreen and [can be seen in the interactive BOM](https://klipper-fan-hat.mikethomas.info/).\n\n## Fasteners\n\n| Item                | Quantity | Received | Notes                                              |\n| ------------------- | -------- | -------- | -------------------------------------------------- |\n| M2.5x6 BHCS         | 4        | 50       | To mount the hat to the Raspberry Pi               |\n| M2.5x14 BHCS        | 4        | 10       | To mount the Fan                                   |\n| M2.5 Nut            | 4        | 50       | To mount the Fan                                   |\n| M2.5 Brass Standoff | 4        | 16       | To stop the fan inputs shorting on the HDMI Socket |\n\n## Connectors\n\n| Item                              | Quantity | Received           | Notes                           |\n| --------------------------------- | -------- | ------------------ | ------------------------------- |\n| 2 Pin JST-XH Header               | 5        | 20                 | FAN1-FAN5                       |\n| 3 Pin JST-XH Header               | 1        | 20                 | J4                              |\n| 4 Pin JST-XH Header               | 1        | 20                 | J3                              |\n| 5 Pin JST-XH Header               | 1        | 20                 | J2                              |\n| 40 Pin Raspberry Pi Header        | 1        | 7                  | J8                              |\n| Dupont Pin Headers                | 41 Pins  | 10 x 40 pin strips | J7, JP1-JP5, WP1, GPIO20-GPIO25 |\n| Jumper Cap 2.54mm                 | 6        | 109                | JP1-JP5, WP1                    |\n| KF301 Screw Terminal (5mm pitch)  | 1        | 10                 | J1                              |\n| PCB Panel Mount Blade Fuse Holder | 1        | 10                 | F1                              |\n\n## SMD Components\n\n| Item                                    | Quantity | Received | Notes                  |\n| --------------------------------------- | -------- | -------- | ---------------------- |\n| 100nF Capacitor (1206 Package)          | 1        | 20       | C1                     |\n| 100Ω Resistor (1206 Package)            | 5        | 123      | R7, R9, R11, R13, R15  |\n| 1kΩ Resistor (1206 Package)             | 1        | 127      | R1                     |\n| 3.9kΩ Resistor (1206 Package)           | 2        | 112      | R2-R3                  |\n| 4.7kΩ Resistor (1206 Package)           | 7        | 103      | R4, R17-R22            |\n| 10kΩ Resistor (1206 Package)            | 5        | 111      | R8, R10, R12, R14, R16 |\n| LED Red (1206 Package)                  | 7        | 105      | D1-D7                  |\n| IRLML6344-TRPBF Mosfet (SOT-23 Package) | 5        | 100      | Q1-Q5                  |\n\n## Misc\n\n| Item                       | Quantity | Received | Notes                                                                   |\n| -------------------------- | -------- | -------- | ----------------------------------------------------------------------- |\n| 2510 Axial Fan             | 1        | 2        |                                                                         |\n| CAT24C32 EEPROM            | 1        | 15       | U1                                                                      |\n| DIP-8 Socket               | 1        | 20       | Not required, but makes switching EEPROM modules out easier for testing |\n| DS18B20 Temperature Sensor | 1        | 15       |                                                                         |\n\n![Holding a Klipper Fan Hat PCB](/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-in-hand.jpg)\n\n> [!NOTE]\n> Some of the images on this page show Version 1 of the PCB, It was originally called the `Klipper Expander Hat` however I have subsequently renamed it to `Klipper Fan Hat` as decided on the [Voron Discord](https://discord.com/channels/460117602945990666/540528535262068739/1090833386421112933) this was so that should not be confused with the `Klipper Expander`.\n\n# Assembly and Testing\n\nAt present assembly testing has only been done with Version 1 of the Klipper Fan hat.\n\n## Assembly\n\nExcuse the messy soldering, this is the first time I have tried to solder Surface Mount Device (SMD) components, and the pads are TINY, I'm probably going to need to invest in a TS100 (...and provides an excuse to buy a shiny new toy).\n\n![An assembled Klipper Fan Hat](/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-assembled.jpg)\n\nThe first time powering the Hat up, I connected the Mosfets to 5V from the Raspberry Pi USB input. All 5 Fan output LEDs lit up which made me happy, however, this happiness was short lived, as I unfortunately found a major design flaw in my design...\n\n## Testing\n\nI used one of my abused Raspberry Pis that I did not mind if I destroyed by releasing its \"Magic Smoke\" whilst testing the board. This is a Raspberry Pi 3 that unfortunately has lost its ability to talk to Wifi or Bluetooth devices, hence the USB wifi module you can see in any pictures.\n\nI have connected a 12V power supply to VCC for testing, however it should also work for 24V. I switched the power selector jumpers for the Fan mosfets to VCC and tried to switch 12V Fans which also worked succesfully. I have also connected a mini OLED display to the I2C bus and managed to get it to output the default Klipper display.\n\n![Testing the Klipper Fan Hat](/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-testing.jpg)\n\nI have yet to test the Serial port; it just passes the connections directly to the GPIO pins the same way as the I2C port does, so I am pretty sure it will work.\n\nNow to the major design flaw - I neglected to check if the Raspberry Pi is capable of analog input (spoiler - it's not) I have looked into adding an Analog to Digital Converter (ADC), however it will take up quite a bit of space on the board and I am unsure if I could get it to work with Klipper. I have therefore opted to remove the thermistor ports in favour of 2 General Purpose Input/Output connectors for connecting items such as Filament Runout Sensors instead.\n\n![Testing a 1-wire temperature sensor](/assets/blog/printer-klipper-fan-hat/1-wire-temp-sensor.jpg)\n\nIf a temperature sensor is required, I have tested a couple of different DS18B20 temperature sensors, they connect to the 1-wire port and are be [compatable with Klipper](https://www.klipper3d.org/Config_Reference.html#ds18b20-temperature-sensor). It is also possible to connect a HTU21D Temperature and Humidity sensor to the I2C port that is also [compatible with Klipper](https://www.klipper3d.org/Config_Reference.html#htu21d-sensor).\n\nI also have a DHT11 temperature sensor to test on the 1-Wire port. This is not currently compatible with Klipper, but could be used with a [Python script running directly on the Pi](https://www.circuitbasics.com/how-to-set-up-the-dht11-humidity-sensor-on-the-raspberry-pi/).\n\nAfter further testing, I have noticed I have used some incorrect resistor values in some places, I have now updated these to the correct values. I have also removed the decoupling capacitors from the thermistor ports and changed the pull up resistors to 3.9kΩ so that I can repurpose the non working thermistor ports as GPIO the same way I have added into V2.\n\nThese have been tested by connecting the 1-wire and the two GPIO pins to a [rotary encoder](https://github.com/mikepthomas/Klipper-Fan-Hat/blob/main/Software/klipper-fan-hat.cfg#L67-L69), and I have also tested a microswitch acting as a [filament runout sensor](https://github.com/mikepthomas/Klipper-Fan-Hat/blob/main/Software/klipper-fan-hat.cfg#L115-L118). Both of which worked perfectly and I have added example configuration sections to the Klipper config file.\n\n![Testing a rotary encoder](/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-rotary-encoder.jpg)\n\n## The Road to V2\n\n![Holding Version 2 of the PCB](/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-version-2.jpg)\n\nAfter my testing I identified a few improvements that I have now made and are available in the master branch:\n\n- Rename to Klipper Fan Hat\n- Increase the thickness of the power delivery tracks\n- Increase the thickness of the mosfet tracks\n- Covered entire bottom side with ground plane\n- Move the EEPROM decoupling capacitor closer to the chip\n- Add pull up resistor to the 1-Wire pin\n- Move Fan 5 power selector header to the other side of the connector to allow space for fan wiring\n- Add missing component markings for power LED, it's resistor and power input screw terminal\n- Add pin markings to the silkscreen for Power, Serial, SPI and I2C\n- Replace non-working thermistor inputs with GPIO connectors\n- Switch orientation of Fan 1-4 resistors so that it does't matter if they are bridged when soldering\n- Added a status LED that can be controlled by the Klipper host\n- On Board DS18B20 Temperature Sensor\n\nI have received the printed circuit boards for Version 2 of the fan hat however I have not yet assembled one. I have however, purchased a cheap [Hot Air Soldering station](https://www.amazon.co.uk/dp/B0C5M9Q86V) to hopefully put some together a little more professionally with the aim to eventually sell on the [pcb_party channel on the Voron Discord](https://discord.com/channels/460117602945990666/981274124850724965) so watch this space if you would like to puchase one.\n\n# Flash Hat EEPROM\n\n## Install git\n\nWe will need to install Git so we can check out the Raspberry Pi Hats Repository as it is not included in the base Raspberry Pi OS image.\n\n```sh {1, 3, 16}\npi@raspberrypi:~ $ sudo apt update\n...\npi@raspberrypi:~ $ sudo apt install git\nReading package lists... Done\nBuilding dependency tree... Done\nReading state information... Done\nThe following additional packages will be installed:\n  git-man liberror-perl\nSuggested packages:\n  git-daemon-run | git-daemon-sysvinit git-doc git-el git-email git-gui gitk gitweb git-cvs git-mediawiki git-svn\nThe following NEW packages will be installed:\n  git git-man liberror-perl\n0 upgraded, 3 newly installed, 0 to remove and 13 not upgraded.\nNeed to get 6,533 kB/6,564 kB of archives.\nAfter this operation, 33.1 MB of additional disk space will be used.\nDo you want to continue? [Y/n] y\n...\nSetting up git (1:2.30.2-1+deb11u2) ...\n```\n\n## Clone Hats Git Repository\n\nNext we need to get the code from the Raspberry Pi Hats Repository.\n\n```sh {1}\npi@raspberrypi:~ $ git clone https://github.com/raspberrypi/hats.git\nCloning into 'hats'...\nremote: Enumerating objects: 624, done.\nremote: Counting objects: 100% (154/154), done.\nremote: Compressing objects: 100% (65/65), done.\nremote: Total 624 (delta 100), reused 131 (delta 89), pack-reused 470\nReceiving objects: 100% (624/624), 326.80 KiB | 1.56 MiB/s, done.\nResolving deltas: 100% (366/366), done.\n```\n\n## Make EEPROM Utils\n\nOnce we have cloned the repository we need to compile the tools to make the EEPROM image and flash it to the chip.\n\n```sh {1-2, 5}\npi@raspberrypi:~ $ cd hats/eepromutils/\npi@raspberrypi:~/hats/eepromutils $ make -j4\ncc -Wall -Wextra eepmake.c -o eepmake\ncc -Wall -Wextra eepdump.c -o eepdump\npi@raspberrypi:~/hats/eepromutils $ ls\neepdump  eepdump.c  eepflash.sh  eepmake  eepmake.c  eeprom_settings.txt  eeptypes.h  Makefile  README.md\n```\n\n## Enable I2C\n\nTo communicate with the EEPROM chip we need to enable the I2C interface.\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ sudo raspi-config\n```\n\nSelect:\ninterfacing Options -> I2C -> Yes -> ok -> Finish\n\nWe will then need to reboot the Raspberry Pi to enable.\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ sudo reboot\n```\n\nWhen finished restarting, we will need to install the `i2c-tools` package, log in and run:\n\n```sh {1, 14}\npi@raspberrypi:~ $ sudo apt install i2c-tools\nReading package lists... Done\nBuilding dependency tree... Done\nReading state information... Done\nThe following additional packages will be installed:\n  libi2c0 read-edid\nSuggested packages:\n  libi2c-dev python-smbus\nThe following NEW packages will be installed:\n  i2c-tools libi2c0 read-edid\n0 upgraded, 3 newly installed, 0 to remove and 13 not upgraded.\nNeed to get 103 kB of archives.\nAfter this operation, 359 kB of additional disk space will be used.\nDo you want to continue? [Y/n] y\n...\nSetting up i2c-tools (4.2-1+b1) ...\n```\n\n## Connect EEPROM\n\nThe Raspberry Pi should be powered off before making any connections to the GPIO pins.\n\n```sh {1}\npi@raspberrypi:~ $ sudo halt\n```\n\nWe will then need to connect the EEPROM chip as per the following diagram, I did not add the RGB LED or its resistors as I just wanted to flash the EEPROM.\n\n![EEPROM Connection Diagram](https://rpi-magazines.s3-eu-west-1.amazonaws.com/magpi/legacy-assets/2016/03/eeprom-hat-led_bb.jpg)\n\n> Image &copy; 2016 [The MagPi Magazine](https://magpi.raspberrypi.com/articles/make-your-own-hat)\n\nI did not have any 3.9kΩ resistors available but I used 4.7kΩ without any problems.\n\nSwitch the Raspberry Pi back on.\n\n## Test EEPROM is Connected\n\nIf when we try to detect the EEPROM we get a 'No such file or directory' error such as...\n\n```sh {1}\npi@raspberrypi:~ $ i2cdetect -y 9\nError: Could not open file `/dev/i2c-9' or `/dev/i2c/9': No such file or directory\n```\n\n...run the following command as explained in the [EEPROM Utils Docs](https://github.com/raspberrypi/hats/tree/master/eepromutils).\n\n```sh {1}\npi@raspberrypi:~ $ sudo dtoverlay i2c-gpio i2c_gpio_sda=0 i2c_gpio_scl=1 bus=9\n```\n\nYou should then be able to see the EEPROM Chip at address 50:\n\n```sh {1}\npi@raspberrypi:~ $ i2cdetect -y 9\n     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f\n00:                         -- -- -- -- -- -- -- --\n10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n50: 50 -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n70: -- -- -- -- -- -- -- --\n```\n\n## Zero EEPROM\n\nThe Recommended EEPROM in the [Design Guide](https://github.com/raspberrypi/hats/blob/master/designguide.md) at the time of writing is CAT24C32 which is 32kbit (4kbyte).\n\nAs we don't know the state of the EEPROM it is best to clear it by setting it all to zeros.\nIf your EEPROM is a different size you will need to set `count` to the value of kbyte of your chip.\n\nMake a blank image using dd:\n\n```sh {1-2}\npi@raspberrypi:~ $ cd hats/eepromutils/\npi@raspberrypi:~/hats/eepromutils $ dd if=/dev/zero ibs=1k count=4 of=blank.eep\n4+0 records in\n8+0 records out\n4096 bytes (4.1 kB, 4.0 KiB) copied, 0.000941149 s, 4.4 MB/s\n```\n\nVerify it is actually blank with `hexdump`...\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ hexdump blank.eep\n0000000 0000 0000 0000 0000 0000 0000 0000 0000\n*\n0001000\n```\n\n...and flash it to the chip.\n\n```sh {1, 4}\npi@raspberrypi:~/hats/eepromutils $ sudo ./eepflash.sh -w -f=blank.eep -t=24c32\nThis will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.\nThis script comes with ABSOLUTELY no warranty. Continue only if you know what you are doing.\nDo you wish to continue? (yes/no): yes\nWriting...\n4096 bytes (4.1 kB, 4.0 KiB) copied, 17 s, 0.2 kB/s\n8+0 records in\n8+0 records out\n4096 bytes (4.1 kB, 4.0 KiB) copied, 16.7208 s, 0.2 kB/s\nClosing EEPROM Device.\nDone.\n```\n\n## Flash EEPROM\n\nNow that we have a blank EEPROM chip, we can configure and flash the Hat EEPROM image to it.\nOpen the `eeprom_settings.txt` file:\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ nano eeprom_settings.txt\n```\n\nUpdate the contents with the [Klipper Fan Hat settings file from the Repository](https://github.com/mikepthomas/Klipper-Fan-Hat/blob/main/EEPROM/eeprom_settings.txt).\n\nSave and close the file, and then we can make the EEPROM image...\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ ./eepmake eeprom_settings.txt klipper-fan-hat.eep\nOpening file eeprom_settings.txt for read\nUUID=fef562f0-9e28-4453-88c2-c073303e6ab2\nDone reading\nWriting out...\nDone.\n```\n\n...and flash it to the chip.\n\n```sh {1, 4}\npi@raspberrypi:~/hats/eepromutils $ sudo ./eepflash.sh -w -f=klipper-fan-hat.eep -t=24c32\nThis will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.\nThis script comes with ABSOLUTELY no warranty. Continue only if you know what you are doing.\nDo you wish to continue? (yes/no): yes\nWriting...\n0+1 records in\n0+1 records out\n215 bytes copied, 0.788403 s, 0.3 kB/s\nClosing EEPROM Device.\nDone.\n```\n\n## Test EEPROM\n\nThe Hat EEPROM is read on system boot so we will need to reboot the Pi before we can test it:\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ sudo reboot\n```\n\nWe can then read the data using the device tree:\n\n```sh {1-2, 4, 6, 8, 10, 12, 14}\npi@raspberrypi:~ $ cd /proc/device-tree/hat/\npi@raspberrypi:/proc/device-tree/hat $ ls\ncustom_0  name  product  product_id  product_ver  uuid  vendor\npi@raspberrypi:/proc/device-tree/hat $ more name\nhat\npi@raspberrypi:/proc/device-tree/hat $ more vendor\nVoron Design\npi@raspberrypi:/proc/device-tree/hat $ more product\nKlipper Fan Hat\npi@raspberrypi:/proc/device-tree/hat $ more product_id\n0x4b46\npi@raspberrypi:/proc/device-tree/hat $ more product_ver\n0x0002\npi@raspberrypi:/proc/device-tree/hat $ more uuid\nfef562f0-9e28-4453-88c2-c073303e6ab2\n```\n\n## Enable I2C and SPI Automatically\n\nTo allow the hat to automatically enable I2C and SPI we will create a device tree overlay and embed it into the EEPROM. The Raspberry Pi will then enable this at boot time.\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ nano klipper-fan-hat.dts\n```\n\nUpdate the contents with the [Klipper Fan Hat device tree source file from the Repository](https://github.com/mikepthomas/Klipper-Fan-Hat/blob/main/EEPROM/klipper-fan-hat.dts).\n\nSave the file, compile the binary and set the correct permissions to the output file:\n\n```sh {1-2}\npi@raspberrypi:~/hats/eepromutils $ sudo dtc -@ -I dts -O dtb -o klipper-fan-hat.dtb klipper-fan-hat.dts\npi@raspberrypi:~/hats/eepromutils $ sudo chown pi:pi klipper-fan-hat.dtb\n```\n\nYou may need to install the `device-tree-compiler` package if you get any errors running the previous command, however, it was already installed in the version of Raspberry Pi OS that I was using.\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ sudo apt-get install device-tree-compiler\n```\n\nWe can then embed the device tree binary into the flash file...\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ ./eepmake eeprom_settings.txt klipper-fan-hat-with-dt.eep klipper-fan-hat.dtb\nOpening file eeprom_settings.txt for read\nUUID=967cd2a4-9c61-4397-ae2e-5184a7f2b7de\nDone reading\nOpening DT file klipper-fan-hat.dtb for read\nAdding 411 bytes of DT data\nWriting out...\nWriting out DT...\nDone.\n```\n\n...and flash it to the EEPROM the same way we did before:\n\n```sh {1, 4, 12, 15}\npi@raspberrypi:~/hats/eepromutils $ sudo ./eepflash.sh -w -f=blank.eep -t=24c32\nThis will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.\nThis script comes with ABSOLUTELY no warranty. Continue only if you know what you are doing.\nDo you wish to continue? (yes/no): yes\nWriting...\n4096 bytes (4.1 kB, 4.0 KiB) copied, 17 s, 0.2 kB/s\n8+0 records in\n8+0 records out\n4096 bytes (4.1 kB, 4.0 KiB) copied, 16.6287 s, 0.2 kB/s\nClosing EEPROM Device.\nDone.\npi@raspberrypi:~/hats/eepromutils $ sudo ./eepflash.sh -w -f=klipper-fan-hat-with-dt.eep -t=24c32\nThis will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.\nThis script comes with ABSOLUTELY no warranty. Continue only if you know what you are doing.\nDo you wish to continue? (yes/no): yes\nWriting...\n512 bytes copied, 2 s, 0.3 kB/s\n1+1 records in\n1+1 records out\n636 bytes copied, 2.40116 s, 0.3 kB/s\nClosing EEPROM Device.\nDone.\n```\n\nWe can check that I2C and SPI is enabled by switching off I2C using `raspi-config` [the same way we enabled it](#enable-i2c) except clicking `No` when prompted to enable.\n\nAfter another restart you will be able to see the devices `/dev/i2c-1`, and `/dev/spidev0.0` and `/dev/spidev0.1` only when the hat EEPROM is connected.\n\n```sh {1}\npi@raspberrypi:~ $ ls /dev\nautofs         dma_heap   i2c-1    loop4         mmcblk0    ram1   ram5     spidev0.0  tty12  tty21  tty30  tty4   tty49  tty58  ttyAMA0    vcs1   vcsa4     vcsu6    video20\nblock          dri        i2c-2    loop5         mmcblk0p1  ram10  ram6     spidev0.1  tty13  tty22  tty31  tty40  tty5   tty59  ttyprintk  vcs2   vcsa5     vhci     video21\nbtrfs-control  fd         initctl  loop6         mmcblk0p2  ram11  ram7     stderr     tty14  tty23  tty32  tty41  tty50  tty6   uhid       vcs3   vcsa6     video10  video22\nbus            full       input    loop7         mqueue     ram12  ram8     stdin      tty15  tty24  tty33  tty42  tty51  tty60  uinput     vcs4   vcsm-cma  video11  video23\ncachefiles     fuse       kmsg     loop-control  net        ram13  ram9     stdout     tty16  tty25  tty34  tty43  tty52  tty61  urandom    vcs5   vcsu      video12  video31\ncec0           gpiochip0  log      mapper        null       ram14  random   tty        tty17  tty26  tty35  tty44  tty53  tty62  v4l        vcs6   vcsu1     video13  watchdog\nchar           gpiochip1  loop0    media0        ppp        ram15  rfkill   tty0       tty18  tty27  tty36  tty45  tty54  tty63  vchiq      vcsa   vcsu2     video14  watchdog0\nconsole        gpiochip2  loop1    media1        ptmx       ram2   serial1  tty1       tty19  tty28  tty37  tty46  tty55  tty7   vcio       vcsa1  vcsu3     video15  zero\ncuse           gpiomem    loop2    media2        pts        ram3   shm      tty10      tty2   tty29  tty38  tty47  tty56  tty8   vc-mem     vcsa2  vcsu4     video16\ndisk           hwrng      loop3    mem           ram0       ram4   snd      tty11      tty20  tty3   tty39  tty48  tty57  tty9   vcs        vcsa3  vcsu5     video18\n```\n\n## Embed Klipper config in EEPROM\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ nano klipper-fan-hat.cfg\n```\n\nUpdate the contents with the [Klipper config source file from the Repository](https://github.com/mikepthomas/Klipper-Fan-Hat/blob/main/Software/klipper-fan-hat.cfg).\n\nSave the file, and embed the config file into the EEPROM image\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ ./eepmake eeprom_settings.txt klipper-fan-hat-with-dt.eep klipper-fan-hat.dtb -c klipper-fan-hat.cfg\nOpening file eeprom_settings.txt for read\nUUID=62ed7b88-3e38-4958-a397-5271702f3386\nDone reading\nOpening DT file klipper-fan-hat.dtb for read\nAdding 411 bytes of DT data\nOpening custom data file klipper-fan-hat.cfg for read\nAdding 3450 bytes of custom data\nWriting out...\nWriting out DT...\nDone.\n```\n\n...then flash the EEPROM\n\n```sh {1, 4, 12, 15}\npi@raspberrypi:~/hats/eepromutils $ sudo ./eepflash.sh -w -f=blank.eep -t=24c32\nThis will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.\nThis script comes with ABSOLUTELY no warranty. Continue only if you know what you are doing.\nDo you wish to continue? (yes/no): yes\nWriting...\n4096 bytes (4.1 kB, 4.0 KiB) copied, 17 s, 0.2 kB/s\n8+0 records in\n8+0 records out\n4096 bytes (4.1 kB, 4.0 KiB) copied, 16.5953 s, 0.2 kB/s\nClosing EEPROM Device.\nDone.\npi@raspberrypi:~/hats/eepromutils $ sudo ./eepflash.sh -w -f=klipper-fan-hat-with-dt.eep -t=24c32\nThis will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.\nThis script comes with ABSOLUTELY no warranty. Continue only if you know what you are doing.\nDo you wish to continue? (yes/no): yes\nWriting...\n4096 bytes (4.1 kB, 4.0 KiB) copied, 19 s, 0.2 kB/s\n8+0 records in\n8+0 records out\n4096 bytes (4.1 kB, 4.0 KiB) copied, 19.0053 s, 0.2 kB/s\nClosing EEPROM Device.\nDone.\n```\n\nRestart the Pi and we can then [copy the config out of the device tree into the klipper config directory](#remaining-configuration).\n\n![Flashing an EEPROM with a Raspberry Pi](/assets/blog/printer-klipper-fan-hat/eeprom-connection-to-rpi.jpg)\n\n# Klipper Setup\n\nTo set up Klipper on a Raspberry Pi using the same Pi as secondary mcu, you can follow the steps in the [RPi microcontroller section of my Klipper Firmware setup page](printer-klipper-firmware#rpi-microcontroller).\n\n## Remaining configuration\n\nOnce you have the RPi microcontroller set up, you can copy the config from the EEPROM chip of the hat into the Klipper config directory, using the following command:\n\n```sh {1}\ncat /proc/device-tree/hat/custom_1 > ~/printer_data/config/klipper-fan-hat.cfg\n```\n","lastmod":"2024-06-03T20:59:33.506Z"},"related":[]},"__N_SSG":true}