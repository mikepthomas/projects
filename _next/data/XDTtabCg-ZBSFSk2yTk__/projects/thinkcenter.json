{"pageProps":{"post":{"slug":"thinkcenter","related":["/projects/thinkpad"],"external":[],"title":"Thinkcenter","heading":"Using small machines to create a Proxmox cluster","date":"2025-03-14T23:22:38.962Z","preview":"/assets/blog/thinkcenter/thinkcenter-hero.jpg","author":{"name":"Mike Thomas","picture":"/assets/authors/mike.jpg"},"description":"Making old outdated machines do modern things.","tags":["Computers"],"categories":[],"keywords":["Computers","Lenovo","Thinkcenter"],"promoted":false,"content":"\n# Table of contents\n\n# Intro\n\nMy first Thinkcenter was bought to replace my old “Shed Server” an old HP 3ghz pentium 4 pc with 1gb of ram that I rescued from e-waste from work.\n\nI upgraded it with a 320GB Western digital raptor drive and installed a student edition of windows server 2008 to run my website via IIS before I used to host it on GitHub Pages.\n\nIt was affectionately called the “Shed Server” as it was installed in my garden shed and connected to the internet via WiFi in my flat whilst I was in University.\n\nIt was likely due to this, why it eventually went to [Silicon Heaven](https://www.youtube.com/watch?v=lm6YnAqPv4w), probably due to the extreme changes in temperature, humidity or by being a home to many a spider.\n\nThe replacement for \"Shed Server\" was named \"Lenny\" (just because it is a Lenovo) and going forward my Proxmox cluster name of Thinkcenter Tinys has inherited the Monika.\n\n# The Machines\n\n## Small Form Factor\n\n| Item     | CPU           | Memory             | Wifi                           | Ethernet | Storage              | OS                  | Hostname | Notes |\n| -------- | ------------- | ------------------ | ------------------------------ | -------- | -------------------- | ------------------- | -------- | ----- |\n| A55 9638 | Core2Duo-6600 | 4GB Samsung 666MHz | TP-Link Wireless-N PCI Adapter | Onboard  | 320GB WD Raptor 3.5\" | Windows Server 2008 | Lenny    |       |\n\n## Tiny 1L\n\n### Router\n\n| Item  | CPU      | Memory             | Wifi                            | Ethernet                                                | Storage                     | OS                                             | Hostname  | Notes |\n| ----- | -------- | ------------------ | ------------------------------- | ------------------------------------------------------- | --------------------------- | ---------------------------------------------- | --------- | ----- |\n| M720Q | i5-8400T | 8GB Micron 2133MHz | Intel Wireless 8265, No Antenna | Intel I219-V Gigabit & Intel PRO I350 Quad Port Gigabit | 256GB Sandisk 2.5\" SATA SSD | [Proxmox VE (9.1.4)](https://www.proxmox.com/) | Scrooge   |       |\n| M720Q | i5-8400T | 8GB Micron 2133MHz | Intel Wireless 8265, No Antenna | Intel I219-V Gigabit & Intel PRO I350 Quad Port Gigabit | 256GB Sandisk 2.5\" SATA SSD | [Proxmox VE (9.1.4)](https://www.proxmox.com/) | Duckworth |       |\n\n> [!NOTE]\n> These machines will not be part of the main Proxmox cluster but will replace some aging and no longer supported gigabit switches in the house, and will also host VMs for [Proxmox Datacenter Manager](https://www.proxmox.com/en/about/company-details/press-releases/proxmox-datacenter-manager-alpha) and [Sonatype Nexus Repository Community Edition](https://www.sonatype.com/products/nexus-community-edition-download)\n\n### Proxmox Cluster\n\n| Item  | CPU      | Memory                | Wifi    | Ethernet                                      | NVME                             | SATA                            | OS                                             | Hostname | Notes                                           |\n| ----- | -------- | --------------------- | ------- | --------------------------------------------- | -------------------------------- | ------------------------------- | ---------------------------------------------- | -------- | ----------------------------------------------- |\n| M720Q | i5-8500T | 32GB Hypertec 2400MHz | Removed | Intel I219-V Gigabit & Realtek RTL8125 2.5GbE | 1TB Crucial P3 Plus M.2 NVME SSD | 256GB Micron 1300 2.5\" SATA SSD | [Proxmox VE (9.1.4)](https://www.proxmox.com/) | Huey     | Installed in [10\" Rack](homelab#10-server-rack) |\n| M720Q | i5-8500T | 32GB Hypertec 2400MHz | Removed | Intel I219-V Gigabit & Realtek RTL8125 2.5GbE | 1TB Crucial P3 Plus M.2 NVME SSD | 256GB Micron 1300 2.5\" SATA SSD | [Proxmox VE (9.1.4)](https://www.proxmox.com/) | Dewey    | Installed in [10\" Rack](homelab#10-server-rack) |\n| M720Q | i5-8500T | 32GB Hypertec 2400MHz | Removed | Intel I219-V Gigabit & Realtek RTL8125 2.5GbE | 1TB Crucial P3 Plus M.2 NVME SSD | 256GB Micron 1300 2.5\" SATA SSD | [Proxmox VE (9.1.4)](https://www.proxmox.com/) | Louie    | Installed in [10\" Rack](homelab#10-server-rack) |\n\n#### Spare\n\n| Item  | CPU      | Memory               | Wifi    | Ethernet             | NVME                           | SATA                            | OS                                             | Hostname | Notes                                           |\n| ----- | -------- | -------------------- | ------- | -------------------- | ------------------------------ | ------------------------------- | ---------------------------------------------- | -------- | ----------------------------------------------- |\n| M720Q | i5-8500T | 16GB Ramaxel 2666MHz | Removed | Intel I219-V Gigabit |                                | 256GB Micron 1300 2.5\" SATA SSD | [Proxmox VE (9.1.4)](https://www.proxmox.com/) | Donald   | Installed in [10\" Rack](homelab#10-server-rack) |\n| M720Q | i5-8500T | 16GB Micron 2666MHz  | Removed | Intel I219-V Gigabit | 512GB Micron 3400 M.2 NVME SSD | 256GB Micron 1300 2.5\" SATA SSD | [Proxmox VE (9.1.4)](https://www.proxmox.com/) | Daisy    | Installed in [10\" Rack](homelab#10-server-rack) |\n\n### Desktops\n\n| Item  | CPU      | Memory                | Wifi                                           | Ethernet             | NVME                        | SATA                        | OS                                             | Hostname | Notes                  |\n| ----- | -------- | --------------------- | ---------------------------------------------- | -------------------- | --------------------------- | --------------------------- | ---------------------------------------------- | -------- | ---------------------- |\n| M720Q | i5-9400T | 16GB SK Hynix 2666MHz | Intel Wireless 8265, With Antenna              | Intel I219-V Gigabit |                             | 256GB Samsung 2.5\" SATA SSD | Windows 11 Pro 64                              |          |                        |\n| M720Q | i5-9400T | 16GB SK Hynix 2666MHz | Intel Wireless 8265, With Antenna              | Intel I219-V Gigabit |                             | 256GB Samsung 2.5\" SATA SSD | Windows 11 Pro 64                              |          |                        |\n| M710Q | i7-7700T | 16GB SK Hynix 2400MHz | Intel Dual Band Wireless-AC 3165, With Antenna | Intel I219-V Gigabit | 256GB WD Black M.2 NVME SSD | 1TB WD Black 2.5\" SATA SSHD | [Proxmox VE (9.1.4)](https://www.proxmox.com/) |          | With Lenovo VESA Mount |\n\n# Sonatype Nexus Repository\n\nAs most of the Operating Systems I use are based upon Debian I have chosen to install Nexus to host APT proxies for the main Debian repositories so that updates will only be downloaded once and each machine can then retrieve the local copy from Nexus rather than having to re-download the updates from the internet.\n\n## Download Nexus and Install to `/srv`\n\n```sh\ncd Downloads/\nwget https://download.sonatype.com/nexus/3/nexus-3.83.1-03-linux-x86_64.tar.gz\ntar xvf nexus-3.83.1-03-linux-x86_64.tar.gz\nsudo mv nexus-3.83.1-03 /srv\nsudo mv sonatype-work/ /srv\nsudo adduser nexus --system\nsudo chown -R nexus:nogroup /srv/nexus-3.83.1-03/\nsudo chown -R nexus:nogroup /srv/sonatype-work/\n```\n\n## Update Config\n\nAdd the following to `/srv/nexus-3.83.1-03/bin/nexus.rc`:\n\n```ini\nrun_as_user=\"nexus\"\n```\n\nAdd the following to `/srv/nexus-3.83.1-03/bin/nexus.vmoptions`:\n\n```ini\n# Updated Memory Size\n  -Xms1200m\n  -Xmx1200m\n  -XX:MaxDirectMemorySize=2G\n# Added User Root to fix file permissions error on nexus boot\n-Djava.util.prefs.userRoot=../sonatype-work/nexus3/javaprefs\n```\n\n## Install As Service\n\nCreate a symbolic link to the binary of the latest Nexus version:\n\n```sh\nsudo ln -s /srv/nexus-3.83.1-03/bin/nexus /etc/init.d/nexus\n```\n\nCreate the file `/etc/systemd/system/nexus.service` with the content:\n\n```ini\n[Unit]\nDescription=nexus service\nAfter=network.target\n\n[Service]\nType=forking\nLimitNOFILE=65536\nExecStart=/etc/init.d/nexus start\nExecStop=/etc/init.d/nexus stop\nUser=nexus\nRestart=on-abort\nTimeoutSec=600\n\n[Install]\nWantedBy=multi-user.target\n```\n\nEnable and start the service and check the logs:\n\n```sh\nsudo systemctl daemon-reload\nsudo systemctl enable nexus.service\nsudo systemctl start nexus.service\njournalctl -xeu nexus.service\ntail -f /srv/sonatype-work/nexus3/log/nexus.log\ncat /srv/sonatype-work/nexus3/log/nexus.log | grep ERROR\ncat /srv/sonatype-work/nexus3/log/nexus.log | grep WARN\n```\n\n## Nexus Frontend\n\n```sh\ncat /opt/sonatype-work/nexus3/admin.password\n```\n\n- Visit http://localhost:8081/\n- Change Admin Password\n- Add APT Proxies\n  - [adoptium](https://packages.adoptium.net/artifactory/deb)\n  - [debian](http://deb.debian.org/debian/)\n  - [debian-security](http://security.debian.org/debian-security/)\n  - [docker-debian](https://download.docker.com/linux/debian)\n  - [docker-raspbian](https://download.docker.com/linux/raspbian)\n  - [mozilla](https://packages.mozilla.org/apt)\n  - [openmediavault-packages](https://openmediavault.github.io/packages/)\n  - [openmediavault-public](http://packages.openmediavault.org/public/)\n  - [pi-top-os](https://packages.pi-top.com/pi-top-os/debian/)\n  - [proxmox-bs](http://download.proxmox.com/debian/pbs)\n  - [proxmox-dm](http://download.proxmox.com/debian/pdm)\n  - [proxmox-ve](http://download.proxmox.com/debian/pve)\n  - [raspbian](http://raspbian.raspberrypi.org/raspbian/)\n  - [raspi](http://archive.raspberrypi.com/debian/)\n\n# Proxmox Virtual Environment (VE)\n\nEach of the nodes that I want to run Proxmox on will be set up with the following config.\n\n## Proxmox VE Post Install Script\n\n```sh\nbash -c \"$(curl -fsSL https://raw.githubusercontent.com/community-scripts/ProxmoxVE/main/tools/pve/post-pve-install.sh)\"\nbash -c \"$(curl -fsSL https://raw.githubusercontent.com/community-scripts/ProxmoxVE/main/tools/pve/scaling-governor.sh)\"\nbash -c \"$(curl -fsSL https://raw.githubusercontent.com/community-scripts/ProxmoxVE/main/tools/pve/microcode.sh)\"\n```\n\n## Update APT Repositories\n\nOne of the first things I do when setting up a new machine is to update apt to use the Nexus repository we set up in the last section.\n\n```sh\nnano /etc/apt/auth.conf.d/nexus.mikethomas.info.conf\nnano /etc/apt/sources.list\nnano /etc/apt/sources.list.d/ceph.list\nnano /etc/apt/sources.list.d/pve-enterprise.list\nnano /etc/apt/sources.list.d/pbs-enterprise.list\nnano /etc/apt/sources.list.d/pve-install-repo.list\nnano /etc/apt/sources.list.d/pbs-install-repo.list\nnano /etc/apt/sources.list.d/pvetest-for-beta.list\nnano /etc/apt/sources.list.d/pbstest-for-beta.list\n```\n\n## Install Useful tools\n\n```sh\napt update\napt install avahi-daemon htop net-tools\nsystemctl status avahi-daemon\nhtop\nifconfig\n```\n\n## Microcode\n\n### AMD\n\n```sh\napt list --installed | grep microcode\napt install amd64-microcode\ndmesg | grep microcode\n```\n\n### Intel\n\n```sh\napt list --installed | grep microcode\napt install intel-microcode\ndmesg | grep microcode\n```\n\n## Sensors\n\n```sh\napt install lm-sensors\nmodprobe nct6683 force=on\nsensors\n```\n\n## Update Container images\n\n```sh\npveam update\n```\n\n## HDMI audio crackling fix\n\n```sh\necho \"options snd-hda-intel enable_msi=1\" >> /etc/modprobe.d/snd-hda-intel.conf\n```\n\n## PCI(e) Passthrough\n\n### Verify IOMMU is enabled\n\n```sh\ndmesg | grep -e AMD -e DMAR -e IOMMU\n```\n\nThere should be a line that looks like \"DMAR: IOMMU enabled\". If there is no output, something is wrong.\n\n### Verify IOMMU interrupt remapping is enabled\n\n```sh\ndmesg | grep 'remapping'\n```\n\nYou should see one of the following lines:\n\n```\nAMD-Vi: Interrupt remapping enabled\nDMAR-IR: Enabled IRQ remapping in x2apic mode ('x2apic' can be different on old CPUs, but should still work)\n```\n\n### Enable IOMMU\n\n#### AMD\n\nupdate to the following in /etc/default/grub:\n\n```ini\nGRUB_CMDLINE_LINUX=\"iommu=pt pcie_acs_override=downstream initcall_blacklist=sysfb_init\"\n```\n\n#### Intel\n\nupdate to the following in /etc/default/grub:\n\n```ini\nGRUB_CMDLINE_LINUX=\"intel_iommu=on iommu=pt initcall_blacklist=sysfb_init\"\n```\n\n#### Update grub\n\n```sh\nupdate-grub\nreboot\ncat /proc/cmdline\n```\n\n### VFIO\n\n```sh\necho \"vfio\" >> /etc/modules\necho \"vfio_iommu_type1\" >> /etc/modules\necho \"vfio_pci\" >> /etc/modules\nupdate-initramfs -u -k all\n```\n\n#### Get Hardware IDs\n\n```sh\nlspci -nnk | grep -e 'AMD' -e 'Intel'\npvesh get /nodes/{nodename}/hardware/pci --pci-class-blacklist \"\"\n```\n\n#### AMD\n\n```sh\necho \"options vfio-pci ids=1002:67df,1002:aaf0 disable_vga=1\" >> /etc/modprobe.d/vfio.conf\necho \"softdep radeon pre: vfio-pci\" >> /etc/modprobe.d/vfio.conf\necho \"softdep amdgpu pre: vfio-pci\" >> /etc/modprobe.d/vfio.conf\n```\n\n#### Intel\n\n```sh\necho \"options vfio-pci ids=8086:5912,8086:a2f0 disable_vga=1\" >> /etc/modprobe.d/vfio.conf\necho \"softdep i915 pre: vfio-pci\" >> /etc/modprobe.d/vfio.conf\necho \"softdep snd_hda_intel pre: vfio-pci\" >> /etc/modprobe.d/vfio.conf\necho \"softdep snd_hda_codec_hdmi pre: vfio-pci\" >> /etc/modprobe.d/vfio.conf\n```\n\n#### Verify Enabled\n\n```sh\nreboot\ndmesg | grep -i vfio\nlsmod | grep vfio\n```\n\n### Dump GPU BIOS\n\n```sh\ncd /sys/bus/pci/devices/0000:01:00.0/\necho 1 > rom\ncat rom > /usr/share/kvm/r9270.bin\necho 0 > rom\n```\n\n### Mediated Devices (vGPU, GVT-g)\n\n```sh\necho \"i915.enable_gvt=1\" >> /etc/modules\nls /sys/bus/pci/devices/0000:00:02.0/mdev_supported_types\nlsmod | grep kvmgt\ndmesg | grep -iE \"gvt\"\ncat /sys/module/kvm_intel/parameters/nested\n```\n\n# Proxmox Backup Server (BS)\n\n## Proxmox BS Post Install Script\n\n```sh\nbash -c \"$(curl -fsSL https://raw.githubusercontent.com/community-scripts/ProxmoxVE/main/tools/pve/post-pbs-install.sh)\"\nbash -c \"$(curl -fsSL https://raw.githubusercontent.com/community-scripts/ProxmoxVE/main/tools/pve/pbs_microcode.sh)\"\n```\n\n## Create Datastore\n\n- Navigate to https://{hostname}.local:8007\n- login\n- Add Datastore\n\n# Setup Virtual Environment Nodes\n\n## Setup Network\n\n- Node -> System -> Network -> Linux Bridge -> Edit -> VLAN aware\n- Node -> System -> Network -> DNS\n  - Add 8.8.8.8\n  - Add 8.8.4.4\n\n## Add Resource Mappings\n\n- Datacenter -> Resource Mappings -> PCI Devices -> Add\n  - GPU1 = 0000:00:02.0\n  - Sound = 0000:00:1f.3\n  - WiFi = 0000:02:00.0\n\n- Datacenter -> Resource Mappings -> USB Devices -> Add\n  - Bluetooth = 8087:0a2a\n  - Keyboard1 = 05af:8277\n  - Mouse1 = 045e:076c\n\n## Connect to Grafana\n\n- Datacenter -> Metric Server -> Add -> InfluxDB\n  - Name = cbridge\n  - Enabled = Yes\n  - Server = cbridge.local\n  - Port = 8089\n\n## Add Remote Storage\n\n### Proxmox Backup Server\n\n- Datacenter -> Storage -> Add -> Proxmox Backup Server\n- Remove `VZDump backup` file from `local` Directory storage\n\n### NAS\n\n- Datacenter -> Storage -> Add -> NFS\n  - Remove `Disk image` and Add `ISO image` and `Container template`\n- Upload ISO images\n  - Debian 13 KDE\n  - Windows 10\n  - Windows 11\n  - Virtio Windows Drivers\n- Download Container templates\n  - debian-12-standard\n  - ubuntu-24.04-standard\n","lastmod":"2026-01-21T22:34:38.772Z"},"related":[{"slug":"thinkpad","related":[],"external":[],"title":"Thinkpads","heading":"","date":"","preview":"/assets/blog/thinkpad/thinkpad-hero.jpg","author":{"name":"","picture":""},"description":"","tags":[],"categories":[],"keywords":[],"promoted":false,"content":""}]},"__N_SSG":true}