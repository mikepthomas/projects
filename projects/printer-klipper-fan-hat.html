<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><meta property="fb:app_id" content="395776161315353" data-next-head=""/><meta property="og:locale" content="en_GB" data-next-head=""/><meta property="og:site_name" content="I wish I was cool... I wish I was Mike Thomas" data-next-head=""/><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" data-next-head=""/><link rel="manifest" href="/favicon/site.webmanifest" data-next-head=""/><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#000000" data-next-head=""/><link rel="shortcut icon" href="/favicon/favicon.ico" data-next-head=""/><meta name="msapplication-TileColor" content="#000000" data-next-head=""/><meta name="msapplication-config" content="/favicon/browserconfig.xml" data-next-head=""/><meta name="theme-color" content="#000" data-next-head=""/><title data-next-head="">Klipper Fan Hat | I wish I was cool... I wish I was Mike Thomas</title><meta name="robots" content="index,follow" data-next-head=""/><meta name="description" content="Making a Raspberry Pi Hat based on the Klipper Expander, to control additional fans using the Pi as a Secondary MCU in Klipper Firmware, the Klipper Fan Hat." data-next-head=""/><meta property="og:title" content="Creating a Printed Circuit Board to control fans in Klipper" data-next-head=""/><meta property="og:description" content="Making a Raspberry Pi Hat based on the Klipper Expander, to control additional fans using the Pi as a Secondary MCU in Klipper Firmware, the Klipper Fan Hat." data-next-head=""/><meta property="og:url" content="https://www.mikethomas.info/projects/printer-klipper-fan-hat" data-next-head=""/><meta property="og:type" content="article" data-next-head=""/><meta property="article:published_time" content="2023-03-21T00:00:00.000Z" data-next-head=""/><meta property="article:modified_time" content="2024-06-03T20:59:33.506Z" data-next-head=""/><meta property="article:tag" content="Printed Circuit Board" data-next-head=""/><meta property="article:tag" content="Raspberry Pi" data-next-head=""/><meta property="og:image" content="https://www.mikethomas.info/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-hero.jpg" data-next-head=""/><link rel="canonical" href="https://www.mikethomas.info/projects/printer-klipper-fan-hat" data-next-head=""/><meta name="keywords" content="Klipper,Klipper Expander,Klipper Fan Hat" data-next-head=""/><script type="application/ld+json" data-next-head="">{"@context":"https://schema.org","@type":"BlogPosting","datePublished":"2023-03-21T00:00:00.000Z","description":"Making a Raspberry Pi Hat based on the Klipper Expander, to control additional fans using the Pi as a Secondary MCU in Klipper Firmware, the Klipper Fan Hat.","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.mikethomas.info/projects/printer-klipper-fan-hat"},"headline":"Creating a Printed Circuit Board to control fans in Klipper","image":["https://www.mikethomas.info/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-hero.jpg"],"dateModified":"2024-06-03T20:59:33.506Z","author":{"@type":"Person","name":"Mike Thomas"}}</script><link rel="preload" href="/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-hero.jpg" as="image" data-next-head=""/><link rel="preload" href="/_next/static/css/c6f92de8e742614c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c6f92de8e742614c.css" data-n-g=""/><link rel="preload" href="/_next/static/css/393b0371505a9873.css" as="style"/><link rel="stylesheet" href="/_next/static/css/393b0371505a9873.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-a339f4a57035852b.js" defer=""></script><script src="/_next/static/chunks/framework-a6e0b7e30f98059a.js" defer=""></script><script src="/_next/static/chunks/main-a612c2988afed858.js" defer=""></script><script src="/_next/static/chunks/pages/_app-30e2974eb524b097.js" defer=""></script><script src="/_next/static/chunks/3614f49b-f41f0efde8a71c1f.js" defer=""></script><script src="/_next/static/chunks/04ce947b-4d20b65e4c63866a.js" defer=""></script><script src="/_next/static/chunks/982-f9815873e706e292.js" defer=""></script><script src="/_next/static/chunks/485-7196188b3ce17bec.js" defer=""></script><script src="/_next/static/chunks/pages/projects/%5Bslug%5D-0128a563287ec87a.js" defer=""></script><script src="/_next/static/Y5mSgE8YhqnLmiRs80-DT/_buildManifest.js" defer=""></script><script src="/_next/static/Y5mSgE8YhqnLmiRs80-DT/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="navigation"><a class="navigation_github-banner__Smckk github-fork-ribbon d-none d-md-block" href="https://github.com/mikepthomas/projects" target="_blank" rel="noopener noreferrer" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a><nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top"><div class="container-fluid"><a href="/" class="navbar-brand"><img class="navigation_navbar-logo__YrC5F" src="/logo-blue.png" alt="Mike Thomas"/></a><button aria-label="Toggle navigation" type="button" class="navbar-toggler"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse"><ul class="mr-auto navbar-nav"><li class="nav-item"><a href="https://github.com/mikepthomas" target="_blank" class="nav-link"><svg data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github" role="img" viewBox="0 0 512 512" aria-hidden="true"><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3 .3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5 .3-6.2 2.3zm44.2-1.7c-2.9 .7-4.9 2.6-4.6 4.9 .3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM252.8 8c-138.7 0-244.8 105.3-244.8 244 0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1 100-33.2 167.8-128.1 167.8-239 0-138.7-112.5-244-251.2-244zM105.2 352.9c-1.3 1-1 3.3 .7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3 .3 2.9 2.3 3.9 1.6 1 3.6 .7 4.3-.7 .7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3 .7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3 .7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg> <!-- -->GitHub<!-- --> Profile</a></li><li class="nav-item"><a href="https://www.linkedin.com/in/mikepaulthomas" target="_blank" class="nav-link"><svg data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin" role="img" viewBox="0 0 448 512" aria-hidden="true"><path fill="currentColor" d="M416 32L31.9 32C14.3 32 0 46.5 0 64.3L0 447.7C0 465.5 14.3 480 31.9 480L416 480c17.6 0 32-14.5 32-32.3l0-383.4C448 46.5 433.6 32 416 32zM135.4 416l-66.4 0 0-213.8 66.5 0 0 213.8-.1 0zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77zM384.3 416l-66.4 0 0-104c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9l0 105.8-66.4 0 0-213.8 63.7 0 0 29.2 .9 0c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9l0 117.2z"></path></svg> <!-- -->LinkedIn<!-- --> Profile</a></li><li class="nav-item"><a href="https://instagram.com/montycrabapple" target="_blank" class="nav-link"><svg data-prefix="fab" data-icon="instagram" class="svg-inline--fa fa-instagram" role="img" viewBox="0 0 448 512" aria-hidden="true"><path fill="currentColor" d="M224.3 141a115 115 0 1 0 -.6 230 115 115 0 1 0 .6-230zm-.6 40.4a74.6 74.6 0 1 1 .6 149.2 74.6 74.6 0 1 1 -.6-149.2zm93.4-45.1a26.8 26.8 0 1 1 53.6 0 26.8 26.8 0 1 1 -53.6 0zm129.7 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM399 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"></path></svg> <!-- -->Instagram<!-- --> Profile</a></li><li class="nav-item"><a href="https://discordapp.com/users/460182324626325535" target="_blank" class="nav-link"><svg data-prefix="fab" data-icon="discord" class="svg-inline--fa fa-discord" role="img" viewBox="0 0 576 512" aria-hidden="true"><path fill="currentColor" d="M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1 .1s-.6 .4-.8 .8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2c-41.3 7.1-81.6 19.6-119.7 37.1-.3 .1-.6 .4-.8 .7-76.2 113.8-97.1 224.9-86.9 334.5 0 .3 .1 .5 .2 .8s.3 .4 .5 .6c44.4 32.9 94 58 146.8 74.2 .4 .1 .8 .1 1.1 0s.7-.4 .9-.7c11.3-15.4 21.4-31.8 30-48.8 .1-.2 .2-.5 .2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6 .2-.9 .3-.5 .6-.7c3.1-2.3 6.2-4.7 9.1-7.1 .3-.2 .6-.4 .9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1 .7-.2 1-.2s.7 .2 .9 .4c2.9 2.4 6 4.9 9.1 7.2 .2 .2 .4 .4 .6 .7s.2 .6 .2 .9-.1 .6-.3 .9-.4 .5-.6 .6c-14.7 8.6-30 15.9-45.9 21.8-.2 .1-.5 .2-.7 .4s-.3 .4-.4 .7-.1 .5-.1 .8 .1 .5 .2 .8c8.8 17 18.8 33.3 30 48.8 .2 .3 .6 .6 .9 .7s.8 .1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2 .2-.2 .4-.4 .5-.6s.2-.5 .2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2zm195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2z"></path></svg> <!-- -->Discord<!-- --> Profile</a></li></ul></div></div></nav></div><div class="min-h-screen"><main><nav class="breadcrumbs_breadcrumbs__p9HFN position-sticky" aria-label="breadcrumb"><nav class="p-3 bg-light" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="/"><svg data-prefix="fas" data-icon="house" class="svg-inline--fa fa-house mr-2" role="img" viewBox="0 0 512 512" aria-hidden="true"><path fill="currentColor" d="M277.8 8.6c-12.3-11.4-31.3-11.4-43.5 0l-224 208c-9.6 9-12.8 22.9-8 35.1S18.8 272 32 272l16 0 0 176c0 35.3 28.7 64 64 64l288 0c35.3 0 64-28.7 64-64l0-176 16 0c13.2 0 25-8.1 29.8-20.3s1.6-26.2-8-35.1l-224-208zM240 320l32 0c26.5 0 48 21.5 48 48l0 96-128 0 0-96c0-26.5 21.5-48 48-48z"></path></svg>Home</a></li><li class="breadcrumb-item"><a href="/projects">Projects</a></li><li class="active breadcrumb-item" aria-current="page">Klipper Fan Hat</li></ol></nav></nav><div class="container"><article class="mb-16"><div class="mt-24 mb-6 container"><h1 class="text-5xl md:text-7xl lg:text-8xl font-bold tracking-tighter leading-tight md:leading-none mb-12 text-center md:text-left">Creating a Printed Circuit Board to control fans in Klipper</h1></div><div class="mb-6 container"><div class="flex items-center"><img src="/assets/authors/mike.jpg" class="w-12 h-12 rounded-full mr-4" alt="Mike Thomas"/><div class="text-xl font-bold">Mike Thomas</div></div></div><div class="mb-6 container"><svg data-prefix="fas" data-icon="calendar-day" class="svg-inline--fa fa-calendar-day mr-2" role="img" viewBox="0 0 448 512" aria-hidden="true"><path fill="currentColor" d="M128 0c17.7 0 32 14.3 32 32l0 32 128 0 0-32c0-17.7 14.3-32 32-32s32 14.3 32 32l0 32 32 0c35.3 0 64 28.7 64 64l0 288c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64L0 128C0 92.7 28.7 64 64 64l32 0 0-32c0-17.7 14.3-32 32-32zm0 256c-17.7 0-32 14.3-32 32l0 64c0 17.7 14.3 32 32 32l64 0c17.7 0 32-14.3 32-32l0-64c0-17.7-14.3-32-32-32l-64 0z"></path></svg>Created <time dateTime="2023-03-21T00:00:00.000Z">21 March 2023</time>, last modified <time dateTime="2024-06-03T20:59:33.506Z">3 June 2024</time></div><div class="mb-6 container"><span class="mr-2 badge bg-orange rounded-pill">Printed Circuit Board</span><span class="mr-2 badge bg-orange rounded-pill">Raspberry Pi</span></div><div class="mb-6 sm:mx-0 container"><div class="sm:mx-0"><img alt="Cover Image for Creating a Printed Circuit Board to control fans in Klipper" width="1280" height="960" decoding="async" data-nimg="1" class="img-fluid img-thumbnail" style="color:transparent" src="/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-hero.jpg"/></div></div><div class="nav-padding projects-page container"><div class="row"><div class="blog_markdown__sabr0 col-lg-8"><h2 id="table-of-contents">Table of contents</h2><ol><li><a href="/projects/printer-klipper-fan-hat#what-is-the-klipper-fan-hat">What is the Klipper Fan Hat?</a></li><li><a href="/projects/printer-klipper-fan-hat#what-about-the-klipper-expander">What about the Klipper Expander?</a></li><li><a href="/projects/printer-klipper-fan-hat#printed-circuit-board">Printed Circuit Board</a></li><li><a href="/projects/printer-klipper-fan-hat#parts-required">Parts Required</a><ol><li><a href="/projects/printer-klipper-fan-hat#fasteners">Fasteners</a></li><li><a href="/projects/printer-klipper-fan-hat#connectors">Connectors</a></li><li><a href="/projects/printer-klipper-fan-hat#smd-components">SMD Components</a></li><li><a href="/projects/printer-klipper-fan-hat#misc">Misc</a></li></ol></li><li><a href="/projects/printer-klipper-fan-hat#assembly-and-testing">Assembly and Testing</a><ol><li><a href="/projects/printer-klipper-fan-hat#assembly">Assembly</a></li><li><a href="/projects/printer-klipper-fan-hat#testing">Testing</a></li><li><a href="/projects/printer-klipper-fan-hat#the-road-to-v2">The Road to V2</a></li></ol></li><li><a href="/projects/printer-klipper-fan-hat#flash-hat-eeprom">Flash Hat EEPROM</a><ol><li><a href="/projects/printer-klipper-fan-hat#install-git">Install git</a></li><li><a href="/projects/printer-klipper-fan-hat#clone-hats-git-repository">Clone Hats Git Repository</a></li><li><a href="/projects/printer-klipper-fan-hat#make-eeprom-utils">Make EEPROM Utils</a></li><li><a href="/projects/printer-klipper-fan-hat#enable-i2c">Enable I2C</a></li><li><a href="/projects/printer-klipper-fan-hat#connect-eeprom">Connect EEPROM</a></li><li><a href="/projects/printer-klipper-fan-hat#test-eeprom-is-connected">Test EEPROM is Connected</a></li><li><a href="/projects/printer-klipper-fan-hat#zero-eeprom">Zero EEPROM</a></li><li><a href="/projects/printer-klipper-fan-hat#flash-eeprom">Flash EEPROM</a></li><li><a href="/projects/printer-klipper-fan-hat#test-eeprom">Test EEPROM</a></li><li><a href="/projects/printer-klipper-fan-hat#enable-i2c-and-spi-automatically">Enable I2C and SPI Automatically</a></li><li><a href="/projects/printer-klipper-fan-hat#embed-klipper-config-in-eeprom">Embed Klipper config in EEPROM</a></li></ol></li><li><a href="/projects/printer-klipper-fan-hat#klipper-setup">Klipper Setup</a><ol><li><a href="/projects/printer-klipper-fan-hat#remaining-configuration">Remaining configuration</a></li></ol></li></ol><h2 id="what-is-the-klipper-fan-hat">What is the Klipper Fan Hat?</h2><p>I wanted to explore making a Raspberry Pi Hat based on <a href="https://github.com/timmit99/Klipper-Expander" rel="noopener noreferrer" target="_blank">Tim Abraham&#x27;s Klipper Expander</a> to control additional fans using the <a href="https://www.klipper3d.org/RPi_microcontroller.html" rel="noopener noreferrer" target="_blank">Raspberry Pi as a Secondary MCU in Klipper Firmware</a>.</p><h2 id="what-about-the-klipper-expander">What about the Klipper Expander?</h2><p>The Klipper Expander is designed to add 4 additional Mosfet outputs, 2 thermistor inputs, a Neopixel output, a GPIO Header and an I2C header that can be added as a secondary Klipper MCU. The Klipper Fan Hat is supposed to be a re-imagining of this, which can be attached on top of the Raspberry Pi that is used as the Klipper Host.</p><p>The Klipper Fan Hat is not supposed to be a replacement for the Klipper Expander, the Klipper expander can handle more current as it has wider PCB tracks than this PCB. Therefore the Klipper Fan Hat should only be used for lower current devices such as fans. Also, the Klipper Fan Hat does not support Neopixels due to space constraints of fitting it within the footprint of a Raspberry Pi Hat.</p><p>Klipper Fan Hat features:</p><ul><li>SKR Pico compatible input for powering the Pi and Serial communication</li><li>5 Mosfet outputs (with 2 pin JST-XH connectors standard on most fans used on 3D printers)</li><li>Voltage selector jumpers to power each fan from either 5V or VCC supplied by screw terminal</li><li>I2C and 1-Wire and SPI headers for connecting accesories to the Raspberry Pi</li><li><del>2 thermistor inputs</del> (removed, see <a href="/projects/printer-klipper-fan-hat#testing">Testing Section</a> to find out why)</li><li>2 headers connected to General Purpose GPIO pins for accesories such as Filament Run Out Sensors</li></ul><h2 id="printed-circuit-board">Printed Circuit Board</h2><p>The PCB (printed circuit board) was designed in <a href="https://www.kicad.org/" rel="noopener noreferrer" target="_blank">KiCad 7</a> and I have created a <a href="https://github.com/mikepthomas/Klipper-Fan-Hat" rel="noopener noreferrer" target="_blank">repository on my GitHub</a> with the design files and Gerber files.</p><p>Two versions of the board have been produced:</p><ul><li><a href="https://github.com/mikepthomas/Klipper-Fan-Hat/releases/tag/v1.0" rel="noopener noreferrer" target="_blank">Pre-release Version 1</a></li><li><a href="https://github.com/mikepthomas/Klipper-Fan-Hat/releases/tag/v2.0" rel="noopener noreferrer" target="_blank">Release Version 2</a></li></ul><p>I used <a href="https://pcbway.com/" rel="noopener noreferrer" target="_blank">PCBWay</a> to produce the PCBs.</p><p><span style="opacity:0"><img alt="3D render of the front of the Klipper Fan Hat" loading="lazy" width="1280" height="960" decoding="async" data-nimg="1" class="img-fluid img-thumbnail" style="color:transparent" src="/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-front.jpg"/></span></p><p>Although currently untested, the main branch contains the updated version of the board, V2, with a few revisions to fix some bugs that were found when testing the first version of the board.</p><p><span style="opacity:0"><img alt="3D render of the back of the Klipper Fan Hat" loading="lazy" width="1280" height="960" decoding="async" data-nimg="1" class="img-fluid img-thumbnail" style="color:transparent" src="/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-back.jpg"/></span></p><h2 id="parts-required">Parts Required</h2><p>The reference numbers in the notes field refer to the parts required marked on the silkscreen and <a href="https://klipper-fan-hat.mikethomas.info/" rel="noopener noreferrer" target="_blank">can be seen in the interactive BOM</a>.</p><h3 id="fasteners">Fasteners</h3><div class="table-responsive"><table class="table table-sm table-bordered table-striped table-hover"><thead><tr><th>Item</th><th>Quantity</th><th>Received</th><th>Notes</th></tr></thead><tbody><tr><td>M2.5x6 BHCS</td><td>4</td><td>50</td><td>To mount the hat to the Raspberry Pi</td></tr><tr><td>M2.5x14 BHCS</td><td>4</td><td>10</td><td>To mount the Fan</td></tr><tr><td>M2.5 Nut</td><td>4</td><td>50</td><td>To mount the Fan</td></tr><tr><td>M2.5 Brass Standoff</td><td>4</td><td>16</td><td>To stop the fan inputs shorting on the HDMI Socket</td></tr></tbody></table></div><h3 id="connectors">Connectors</h3><div class="table-responsive"><table class="table table-sm table-bordered table-striped table-hover"><thead><tr><th>Item</th><th>Quantity</th><th>Received</th><th>Notes</th></tr></thead><tbody><tr><td>2 Pin JST-XH Header</td><td>5</td><td>20</td><td>FAN1-FAN5</td></tr><tr><td>3 Pin JST-XH Header</td><td>1</td><td>20</td><td>J4</td></tr><tr><td>4 Pin JST-XH Header</td><td>1</td><td>20</td><td>J3</td></tr><tr><td>5 Pin JST-XH Header</td><td>1</td><td>20</td><td>J2</td></tr><tr><td>40 Pin Raspberry Pi Header</td><td>1</td><td>7</td><td>J8</td></tr><tr><td>Dupont Pin Headers</td><td>41 Pins</td><td>10 x 40 pin strips</td><td>J7, JP1-JP5, WP1, GPIO20-GPIO25</td></tr><tr><td>Jumper Cap 2.54mm</td><td>6</td><td>109</td><td>JP1-JP5, WP1</td></tr><tr><td>KF301 Screw Terminal (5mm pitch)</td><td>1</td><td>10</td><td>J1</td></tr><tr><td>PCB Panel Mount Blade Fuse Holder</td><td>1</td><td>10</td><td>F1</td></tr></tbody></table></div><h3 id="smd-components">SMD Components</h3><div class="table-responsive"><table class="table table-sm table-bordered table-striped table-hover"><thead><tr><th>Item</th><th>Quantity</th><th>Received</th><th>Notes</th></tr></thead><tbody><tr><td>100nF Capacitor (1206 Package)</td><td>1</td><td>20</td><td>C1</td></tr><tr><td>100Ω Resistor (1206 Package)</td><td>5</td><td>123</td><td>R7, R9, R11, R13, R15</td></tr><tr><td>1kΩ Resistor (1206 Package)</td><td>1</td><td>127</td><td>R1</td></tr><tr><td>3.9kΩ Resistor (1206 Package)</td><td>2</td><td>112</td><td>R2-R3</td></tr><tr><td>4.7kΩ Resistor (1206 Package)</td><td>7</td><td>103</td><td>R4, R17-R22</td></tr><tr><td>10kΩ Resistor (1206 Package)</td><td>5</td><td>111</td><td>R8, R10, R12, R14, R16</td></tr><tr><td>LED Red (1206 Package)</td><td>7</td><td>105</td><td>D1-D7</td></tr><tr><td>IRLML6344-TRPBF Mosfet (SOT-23 Package)</td><td>5</td><td>100</td><td>Q1-Q5</td></tr></tbody></table></div><h3 id="misc">Misc</h3><div class="table-responsive"><table class="table table-sm table-bordered table-striped table-hover"><thead><tr><th>Item</th><th>Quantity</th><th>Received</th><th>Notes</th></tr></thead><tbody><tr><td>2510 Axial Fan</td><td>1</td><td>2</td><td></td></tr><tr><td>CAT24C32 EEPROM</td><td>1</td><td>15</td><td>U1</td></tr><tr><td>DIP-8 Socket</td><td>1</td><td>20</td><td>Not required, but makes switching EEPROM modules out easier for testing</td></tr><tr><td>DS18B20 Temperature Sensor</td><td>1</td><td>15</td><td></td></tr></tbody></table></div><p><span style="opacity:0"><img alt="Holding a Klipper Fan Hat PCB" loading="lazy" width="1280" height="960" decoding="async" data-nimg="1" class="img-fluid img-thumbnail" style="color:transparent" src="/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-in-hand.jpg"/></span></p><div class="markdown-alert markdown-alert-note"><p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p>Some of the images on this page show Version 1 of the PCB, It was originally called the <code>Klipper Expander Hat</code> however I have subsequently renamed it to <code>Klipper Fan Hat</code> as decided on the <a href="https://discord.com/channels/460117602945990666/540528535262068739/1090833386421112933" rel="noopener noreferrer" target="_blank">Voron Discord</a> this was so that should not be confused with the <code>Klipper Expander</code>.</p></div><h2 id="assembly-and-testing">Assembly and Testing</h2><p>At present assembly testing has only been done with Version 1 of the Klipper Fan hat.</p><h3 id="assembly">Assembly</h3><p>Excuse the messy soldering, this is the first time I have tried to solder Surface Mount Device (SMD) components, and the pads are TINY, I&#x27;m probably going to need to invest in a TS100 (...and provides an excuse to buy a shiny new toy).</p><p><span style="opacity:0"><img alt="An assembled Klipper Fan Hat" loading="lazy" width="1280" height="960" decoding="async" data-nimg="1" class="img-fluid img-thumbnail" style="color:transparent" src="/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-assembled.jpg"/></span></p><p>The first time powering the Hat up, I connected the Mosfets to 5V from the Raspberry Pi USB input. All 5 Fan output LEDs lit up which made me happy, however, this happiness was short lived, as I unfortunately found a major design flaw in my design...</p><h3 id="testing">Testing</h3><p>I used one of my abused Raspberry Pis that I did not mind if I destroyed by releasing its &quot;Magic Smoke&quot; whilst testing the board. This is a Raspberry Pi 3 that unfortunately has lost its ability to talk to Wifi or Bluetooth devices, hence the USB wifi module you can see in any pictures.</p><p>I have connected a 12V power supply to VCC for testing, however it should also work for 24V. I switched the power selector jumpers for the Fan mosfets to VCC and tried to switch 12V Fans which also worked succesfully. I have also connected a mini OLED display to the I2C bus and managed to get it to output the default Klipper display.</p><p><span style="opacity:0"><img alt="Testing the Klipper Fan Hat" loading="lazy" width="1280" height="960" decoding="async" data-nimg="1" class="img-fluid img-thumbnail" style="color:transparent" src="/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-testing.jpg"/></span></p><p>I have yet to test the Serial port; it just passes the connections directly to the GPIO pins the same way as the I2C port does, so I am pretty sure it will work.</p><p>Now to the major design flaw - I neglected to check if the Raspberry Pi is capable of analog input (spoiler - it&#x27;s not) I have looked into adding an Analog to Digital Converter (ADC), however it will take up quite a bit of space on the board and I am unsure if I could get it to work with Klipper. I have therefore opted to remove the thermistor ports in favour of 2 General Purpose Input/Output connectors for connecting items such as Filament Runout Sensors instead.</p><p><span style="opacity:0"><img alt="Testing a 1-wire temperature sensor" loading="lazy" width="1280" height="960" decoding="async" data-nimg="1" class="img-fluid img-thumbnail" style="color:transparent" src="/assets/blog/printer-klipper-fan-hat/1-wire-temp-sensor.jpg"/></span></p><p>If a temperature sensor is required, I have tested a couple of different DS18B20 temperature sensors, they connect to the 1-wire port and are be <a href="https://www.klipper3d.org/Config_Reference.html#ds18b20-temperature-sensor" rel="noopener noreferrer" target="_blank">compatable with Klipper</a>. It is also possible to connect a HTU21D Temperature and Humidity sensor to the I2C port that is also <a href="https://www.klipper3d.org/Config_Reference.html#htu21d-sensor" rel="noopener noreferrer" target="_blank">compatible with Klipper</a>.</p><p>I also have a DHT11 temperature sensor to test on the 1-Wire port. This is not currently compatible with Klipper, but could be used with a <a href="https://www.circuitbasics.com/how-to-set-up-the-dht11-humidity-sensor-on-the-raspberry-pi/" rel="noopener noreferrer" target="_blank">Python script running directly on the Pi</a>.</p><p>After further testing, I have noticed I have used some incorrect resistor values in some places, I have now updated these to the correct values. I have also removed the decoupling capacitors from the thermistor ports and changed the pull up resistors to 3.9kΩ so that I can repurpose the non working thermistor ports as GPIO the same way I have added into V2.</p><p>These have been tested by connecting the 1-wire and the two GPIO pins to a <a href="https://github.com/mikepthomas/Klipper-Fan-Hat/blob/main/Software/klipper-fan-hat.cfg#L67-L69" rel="noopener noreferrer" target="_blank">rotary encoder</a>, and I have also tested a microswitch acting as a <a href="https://github.com/mikepthomas/Klipper-Fan-Hat/blob/main/Software/klipper-fan-hat.cfg#L115-L118" rel="noopener noreferrer" target="_blank">filament runout sensor</a>. Both of which worked perfectly and I have added example configuration sections to the Klipper config file.</p><p><span style="opacity:0"><img alt="Testing a rotary encoder" loading="lazy" width="1280" height="960" decoding="async" data-nimg="1" class="img-fluid img-thumbnail" style="color:transparent" src="/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-rotary-encoder.jpg"/></span></p><h3 id="the-road-to-v2">The Road to V2</h3><p><span style="opacity:0"><img alt="Holding Version 2 of the PCB" loading="lazy" width="1280" height="960" decoding="async" data-nimg="1" class="img-fluid img-thumbnail" style="color:transparent" src="/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-version-2.jpg"/></span></p><p>After my testing I identified a few improvements that I have now made and are available in the master branch:</p><ul><li>Rename to Klipper Fan Hat</li><li>Increase the thickness of the power delivery tracks</li><li>Increase the thickness of the mosfet tracks</li><li>Covered entire bottom side with ground plane</li><li>Move the EEPROM decoupling capacitor closer to the chip</li><li>Add pull up resistor to the 1-Wire pin</li><li>Move Fan 5 power selector header to the other side of the connector to allow space for fan wiring</li><li>Add missing component markings for power LED, it&#x27;s resistor and power input screw terminal</li><li>Add pin markings to the silkscreen for Power, Serial, SPI and I2C</li><li>Replace non-working thermistor inputs with GPIO connectors</li><li>Switch orientation of Fan 1-4 resistors so that it does&#x27;t matter if they are bridged when soldering</li><li>Added a status LED that can be controlled by the Klipper host</li><li>On Board DS18B20 Temperature Sensor</li></ul><p>I have received the printed circuit boards for Version 2 of the fan hat however I have not yet assembled one. I have however, purchased a cheap <a href="https://www.amazon.co.uk/dp/B0C5M9Q86V" rel="noopener noreferrer" target="_blank">Hot Air Soldering station</a> to hopefully put some together a little more professionally with the aim to eventually sell on the <a href="https://discord.com/channels/460117602945990666/981274124850724965" rel="noopener noreferrer" target="_blank">pcb_party channel on the Voron Discord</a> so watch this space if you would like to puchase one.</p><h2 id="flash-hat-eeprom">Flash Hat EEPROM</h2><h3 id="install-git">Install git</h3><p>We will need to install Git so we can check out the Raspberry Pi Hats Repository as it is not included in the base Raspberry Pi OS image.</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~ $ <span class="token function">sudo</span> <span class="token function">apt</span> update
</span><span class="code-line"><span class="token punctuation">..</span>.
</span><span class="code-line highlight-line">pi@raspberrypi:~ $ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> <span class="token function">git</span>
</span><span class="code-line">Reading package lists<span class="token punctuation">..</span>. Done
</span><span class="code-line">Building dependency tree<span class="token punctuation">..</span>. Done
</span><span class="code-line">Reading state information<span class="token punctuation">..</span>. Done
</span><span class="code-line">The following additional packages will be installed:
</span><span class="code-line">  git-man liberror-perl
</span><span class="code-line">Suggested packages:
</span><span class="code-line">  git-daemon-run <span class="token operator">|</span> git-daemon-sysvinit git-doc git-el git-email git-gui gitk gitweb git-cvs git-mediawiki git-svn
</span><span class="code-line">The following NEW packages will be installed:
</span><span class="code-line">  <span class="token function">git</span> git-man liberror-perl
</span><span class="code-line"><span class="token number">0</span> upgraded, <span class="token number">3</span> newly installed, <span class="token number">0</span> to remove and <span class="token number">13</span> not upgraded.
</span><span class="code-line">Need to get <span class="token number">6,533</span> kB/6,564 kB of archives.
</span><span class="code-line">After this operation, <span class="token number">33.1</span> MB of additional disk space will be used.
</span><span class="code-line highlight-line">Do you want to continue? <span class="token punctuation">[</span>Y/n<span class="token punctuation">]</span> y
</span><span class="code-line"><span class="token punctuation">..</span>.
</span><span class="code-line">Setting up <span class="token function">git</span> <span class="token punctuation">(</span><span class="token number">1</span>:2.30.2-1+deb11u2<span class="token punctuation">)</span> <span class="token punctuation">..</span>.
</span></code></pre><h3 id="clone-hats-git-repository">Clone Hats Git Repository</h3><p>Next we need to get the code from the Raspberry Pi Hats Repository.</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~ $ <span class="token function">git</span> clone https://github.com/raspberrypi/hats.git
</span><span class="code-line">Cloning into <span class="token string">&#x27;hats&#x27;</span><span class="token punctuation">..</span>.
</span><span class="code-line">remote: Enumerating objects: <span class="token number">624</span>, done.
</span><span class="code-line">remote: Counting objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">154</span>/154<span class="token punctuation">)</span>, done.
</span><span class="code-line">remote: Compressing objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">65</span>/65<span class="token punctuation">)</span>, done.
</span><span class="code-line">remote: Total <span class="token number">624</span> <span class="token punctuation">(</span>delta <span class="token number">100</span><span class="token punctuation">)</span>, reused <span class="token number">131</span> <span class="token punctuation">(</span>delta <span class="token number">89</span><span class="token punctuation">)</span>, pack-reused <span class="token number">470</span>
</span><span class="code-line">Receiving objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">624</span>/624<span class="token punctuation">)</span>, <span class="token number">326.80</span> KiB <span class="token operator">|</span> <span class="token number">1.56</span> MiB/s, done.
</span><span class="code-line">Resolving deltas: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">366</span>/366<span class="token punctuation">)</span>, done.
</span></code></pre><h3 id="make-eeprom-utils">Make EEPROM Utils</h3><p>Once we have cloned the repository we need to compile the tools to make the EEPROM image and flash it to the chip.</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~ $ <span class="token builtin class-name">cd</span> hats/eepromutils/
</span><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">make</span> <span class="token parameter variable">-j4</span>
</span><span class="code-line">cc <span class="token parameter variable">-Wall</span> <span class="token parameter variable">-Wextra</span> eepmake.c <span class="token parameter variable">-o</span> eepmake
</span><span class="code-line">cc <span class="token parameter variable">-Wall</span> <span class="token parameter variable">-Wextra</span> eepdump.c <span class="token parameter variable">-o</span> eepdump
</span><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">ls</span>
</span><span class="code-line">eepdump  eepdump.c  eepflash.sh  eepmake  eepmake.c  eeprom_settings.txt  eeptypes.h  Makefile  README.md
</span></code></pre><h3 id="enable-i2c">Enable I2C</h3><p>To communicate with the EEPROM chip we need to enable the I2C interface.</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">sudo</span> raspi-config
</span></code></pre><p>Select: interfacing Options -&gt; I2C -&gt; Yes -&gt; ok -&gt; Finish</p><p>We will then need to reboot the Raspberry Pi to enable.</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">sudo</span> <span class="token function">reboot</span>
</span></code></pre><p>When finished restarting, we will need to install the <code>i2c-tools</code> package, log in and run:</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~ $ <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> i2c-tools
</span><span class="code-line">Reading package lists<span class="token punctuation">..</span>. Done
</span><span class="code-line">Building dependency tree<span class="token punctuation">..</span>. Done
</span><span class="code-line">Reading state information<span class="token punctuation">..</span>. Done
</span><span class="code-line">The following additional packages will be installed:
</span><span class="code-line">  libi2c0 read-edid
</span><span class="code-line">Suggested packages:
</span><span class="code-line">  libi2c-dev python-smbus
</span><span class="code-line">The following NEW packages will be installed:
</span><span class="code-line">  i2c-tools libi2c0 read-edid
</span><span class="code-line"><span class="token number">0</span> upgraded, <span class="token number">3</span> newly installed, <span class="token number">0</span> to remove and <span class="token number">13</span> not upgraded.
</span><span class="code-line">Need to get <span class="token number">103</span> kB of archives.
</span><span class="code-line">After this operation, <span class="token number">359</span> kB of additional disk space will be used.
</span><span class="code-line highlight-line">Do you want to continue? <span class="token punctuation">[</span>Y/n<span class="token punctuation">]</span> y
</span><span class="code-line"><span class="token punctuation">..</span>.
</span><span class="code-line">Setting up i2c-tools <span class="token punctuation">(</span><span class="token number">4.2</span>-1+b1<span class="token punctuation">)</span> <span class="token punctuation">..</span>.
</span></code></pre><h3 id="connect-eeprom">Connect EEPROM</h3><p>The Raspberry Pi should be powered off before making any connections to the GPIO pins.</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~ $ <span class="token function">sudo</span> <span class="token function">halt</span>
</span></code></pre><p>We will then need to connect the EEPROM chip as per the following diagram, I did not add the RGB LED or its resistors as I just wanted to flash the EEPROM.</p><p><span style="opacity:0"><img alt="EEPROM Connection Diagram" loading="lazy" width="1280" height="960" decoding="async" data-nimg="1" class="img-fluid img-thumbnail" style="color:transparent" src="https://rpi-magazines.s3-eu-west-1.amazonaws.com/magpi/legacy-assets/2016/03/eeprom-hat-led_bb.jpg"/></span></p><blockquote><p>Image © 2016 <a href="https://magpi.raspberrypi.com/articles/make-your-own-hat" rel="noopener noreferrer" target="_blank">The MagPi Magazine</a></p></blockquote><p>I did not have any 3.9kΩ resistors available but I used 4.7kΩ without any problems.</p><p>Switch the Raspberry Pi back on.</p><h3 id="test-eeprom-is-connected">Test EEPROM is Connected</h3><p>If when we try to detect the EEPROM we get a &#x27;No such file or directory&#x27; error such as...</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~ $ i2cdetect <span class="token parameter variable">-y</span> <span class="token number">9</span>
</span><span class="code-line">Error: Could not <span class="token function">open</span> <span class="token function">file</span> <span class="token variable"><span class="token variable">`</span>/dev/i2c-9&#x27; or <span class="token variable">`</span></span>/dev/i2c/9&#x27;: No such <span class="token function">file</span> or directory
</span></code></pre><p>...run the following command as explained in the <a href="https://github.com/raspberrypi/hats/tree/master/eepromutils" rel="noopener noreferrer" target="_blank">EEPROM Utils Docs</a>.</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~ $ <span class="token function">sudo</span> dtoverlay i2c-gpio <span class="token assign-left variable">i2c_gpio_sda</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">i2c_gpio_scl</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">bus</span><span class="token operator">=</span><span class="token number">9</span>
</span></code></pre><p>You should then be able to see the EEPROM Chip at address 50:</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~ $ i2cdetect <span class="token parameter variable">-y</span> <span class="token number">9</span>
</span><span class="code-line">     <span class="token number">0</span>  <span class="token number">1</span>  <span class="token number">2</span>  <span class="token number">3</span>  <span class="token number">4</span>  <span class="token number">5</span>  <span class="token number">6</span>  <span class="token number">7</span>  <span class="token number">8</span>  <span class="token number">9</span>  a  b  c  d  e  f
</span><span class="code-line">00:                         -- -- -- -- -- -- -- --
</span><span class="code-line"><span class="token number">10</span>: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
</span><span class="code-line"><span class="token number">20</span>: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
</span><span class="code-line"><span class="token number">30</span>: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
</span><span class="code-line"><span class="token number">40</span>: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
</span><span class="code-line"><span class="token number">50</span>: <span class="token number">50</span> -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
</span><span class="code-line"><span class="token number">60</span>: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
</span><span class="code-line"><span class="token number">70</span>: -- -- -- -- -- -- -- --
</span></code></pre><h3 id="zero-eeprom">Zero EEPROM</h3><p>The Recommended EEPROM in the <a href="https://github.com/raspberrypi/hats/blob/master/designguide.md" rel="noopener noreferrer" target="_blank">Design Guide</a> at the time of writing is CAT24C32 which is 32kbit (4kbyte).</p><p>As we don&#x27;t know the state of the EEPROM it is best to clear it by setting it all to zeros. If your EEPROM is a different size you will need to set <code>count</code> to the value of kbyte of your chip.</p><p>Make a blank image using dd:</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~ $ <span class="token builtin class-name">cd</span> hats/eepromutils/
</span><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">ibs</span><span class="token operator">=</span>1k <span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">of</span><span class="token operator">=</span>blank.eep
</span><span class="code-line"><span class="token number">4</span>+0 records <span class="token keyword">in</span>
</span><span class="code-line"><span class="token number">8</span>+0 records out
</span><span class="code-line"><span class="token number">4096</span> bytes <span class="token punctuation">(</span><span class="token number">4.1</span> kB, <span class="token number">4.0</span> KiB<span class="token punctuation">)</span> copied, <span class="token number">0.000941149</span> s, <span class="token number">4.4</span> MB/s
</span></code></pre><p>Verify it is actually blank with <code>hexdump</code>...</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ hexdump blank.eep
</span><span class="code-line">0000000 0000 0000 0000 0000 0000 0000 0000 0000
</span><span class="code-line">*
</span><span class="code-line">0001000
</span></code></pre><p>...and flash it to the chip.</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">sudo</span> ./eepflash.sh <span class="token parameter variable">-w</span> <span class="token parameter variable">-f</span><span class="token operator">=</span>blank.eep <span class="token parameter variable">-t</span><span class="token operator">=</span>24c32
</span><span class="code-line">This will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.
</span><span class="code-line">This script comes with ABSOLUTELY no warranty. Continue only <span class="token keyword">if</span> you know what you are doing.
</span><span class="code-line highlight-line">Do you wish to continue? <span class="token punctuation">(</span>yes/no<span class="token punctuation">)</span>: <span class="token function">yes</span>
</span><span class="code-line">Writing<span class="token punctuation">..</span>.
</span><span class="code-line"><span class="token number">4096</span> bytes <span class="token punctuation">(</span><span class="token number">4.1</span> kB, <span class="token number">4.0</span> KiB<span class="token punctuation">)</span> copied, <span class="token number">17</span> s, <span class="token number">0.2</span> kB/s
</span><span class="code-line"><span class="token number">8</span>+0 records <span class="token keyword">in</span>
</span><span class="code-line"><span class="token number">8</span>+0 records out
</span><span class="code-line"><span class="token number">4096</span> bytes <span class="token punctuation">(</span><span class="token number">4.1</span> kB, <span class="token number">4.0</span> KiB<span class="token punctuation">)</span> copied, <span class="token number">16.7208</span> s, <span class="token number">0.2</span> kB/s
</span><span class="code-line">Closing EEPROM Device.
</span><span class="code-line">Done.
</span></code></pre><h3 id="flash-eeprom">Flash EEPROM</h3><p>Now that we have a blank EEPROM chip, we can configure and flash the Hat EEPROM image to it. Open the <code>eeprom_settings.txt</code> file:</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">nano</span> eeprom_settings.txt
</span></code></pre><p>Update the contents with the <a href="https://github.com/mikepthomas/Klipper-Fan-Hat/blob/main/EEPROM/eeprom_settings.txt" rel="noopener noreferrer" target="_blank">Klipper Fan Hat settings file from the Repository</a>.</p><p>Save and close the file, and then we can make the EEPROM image...</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ ./eepmake eeprom_settings.txt klipper-fan-hat.eep
</span><span class="code-line">Opening <span class="token function">file</span> eeprom_settings.txt <span class="token keyword">for</span> <span class="token builtin class-name">read</span>
</span><span class="code-line"><span class="token assign-left variable">UUID</span><span class="token operator">=</span>fef562f0-9e28-4453-88c2-c073303e6ab2
</span><span class="code-line">Done reading
</span><span class="code-line">Writing out<span class="token punctuation">..</span>.
</span><span class="code-line">Done.
</span></code></pre><p>...and flash it to the chip.</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">sudo</span> ./eepflash.sh <span class="token parameter variable">-w</span> <span class="token parameter variable">-f</span><span class="token operator">=</span>klipper-fan-hat.eep <span class="token parameter variable">-t</span><span class="token operator">=</span>24c32
</span><span class="code-line">This will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.
</span><span class="code-line">This script comes with ABSOLUTELY no warranty. Continue only <span class="token keyword">if</span> you know what you are doing.
</span><span class="code-line highlight-line">Do you wish to continue? <span class="token punctuation">(</span>yes/no<span class="token punctuation">)</span>: <span class="token function">yes</span>
</span><span class="code-line">Writing<span class="token punctuation">..</span>.
</span><span class="code-line"><span class="token number">0</span>+1 records <span class="token keyword">in</span>
</span><span class="code-line"><span class="token number">0</span>+1 records out
</span><span class="code-line"><span class="token number">215</span> bytes copied, <span class="token number">0.788403</span> s, <span class="token number">0.3</span> kB/s
</span><span class="code-line">Closing EEPROM Device.
</span><span class="code-line">Done.
</span></code></pre><h3 id="test-eeprom">Test EEPROM</h3><p>The Hat EEPROM is read on system boot so we will need to reboot the Pi before we can test it:</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">sudo</span> <span class="token function">reboot</span>
</span></code></pre><p>We can then read the data using the device tree:</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~ $ <span class="token builtin class-name">cd</span> /proc/device-tree/hat/
</span><span class="code-line highlight-line">pi@raspberrypi:/proc/device-tree/hat $ <span class="token function">ls</span>
</span><span class="code-line">custom_0  name  product  product_id  product_ver  uuid  vendor
</span><span class="code-line highlight-line">pi@raspberrypi:/proc/device-tree/hat $ <span class="token function">more</span> name
</span><span class="code-line">hat
</span><span class="code-line highlight-line">pi@raspberrypi:/proc/device-tree/hat $ <span class="token function">more</span> vendor
</span><span class="code-line">Voron Design
</span><span class="code-line highlight-line">pi@raspberrypi:/proc/device-tree/hat $ <span class="token function">more</span> product
</span><span class="code-line">Klipper Fan Hat
</span><span class="code-line highlight-line">pi@raspberrypi:/proc/device-tree/hat $ <span class="token function">more</span> product_id
</span><span class="code-line">0x4b46
</span><span class="code-line highlight-line">pi@raspberrypi:/proc/device-tree/hat $ <span class="token function">more</span> product_ver
</span><span class="code-line">0x0002
</span><span class="code-line highlight-line">pi@raspberrypi:/proc/device-tree/hat $ <span class="token function">more</span> uuid
</span><span class="code-line">fef562f0-9e28-4453-88c2-c073303e6ab2
</span></code></pre><h3 id="enable-i2c-and-spi-automatically">Enable I2C and SPI Automatically</h3><p>To allow the hat to automatically enable I2C and SPI we will create a device tree overlay and embed it into the EEPROM. The Raspberry Pi will then enable this at boot time.</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">nano</span> klipper-fan-hat.dts
</span></code></pre><p>Update the contents with the <a href="https://github.com/mikepthomas/Klipper-Fan-Hat/blob/main/EEPROM/klipper-fan-hat.dts" rel="noopener noreferrer" target="_blank">Klipper Fan Hat device tree source file from the Repository</a>.</p><p>Save the file, compile the binary and set the correct permissions to the output file:</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">sudo</span> dtc -@ <span class="token parameter variable">-I</span> dts <span class="token parameter variable">-O</span> dtb <span class="token parameter variable">-o</span> klipper-fan-hat.dtb klipper-fan-hat.dts
</span><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">sudo</span> <span class="token function">chown</span> pi:pi klipper-fan-hat.dtb
</span></code></pre><p>You may need to install the <code>device-tree-compiler</code> package if you get any errors running the previous command, however, it was already installed in the version of Raspberry Pi OS that I was using.</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> device-tree-compiler
</span></code></pre><p>We can then embed the device tree binary into the flash file...</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ ./eepmake eeprom_settings.txt klipper-fan-hat-with-dt.eep klipper-fan-hat.dtb
</span><span class="code-line">Opening <span class="token function">file</span> eeprom_settings.txt <span class="token keyword">for</span> <span class="token builtin class-name">read</span>
</span><span class="code-line"><span class="token assign-left variable">UUID</span><span class="token operator">=</span>967cd2a4-9c61-4397-ae2e-5184a7f2b7de
</span><span class="code-line">Done reading
</span><span class="code-line">Opening DT <span class="token function">file</span> klipper-fan-hat.dtb <span class="token keyword">for</span> <span class="token builtin class-name">read</span>
</span><span class="code-line">Adding <span class="token number">411</span> bytes of DT data
</span><span class="code-line">Writing out<span class="token punctuation">..</span>.
</span><span class="code-line">Writing out DT<span class="token punctuation">..</span>.
</span><span class="code-line">Done.
</span></code></pre><p>...and flash it to the EEPROM the same way we did before:</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">sudo</span> ./eepflash.sh <span class="token parameter variable">-w</span> <span class="token parameter variable">-f</span><span class="token operator">=</span>blank.eep <span class="token parameter variable">-t</span><span class="token operator">=</span>24c32
</span><span class="code-line">This will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.
</span><span class="code-line">This script comes with ABSOLUTELY no warranty. Continue only <span class="token keyword">if</span> you know what you are doing.
</span><span class="code-line highlight-line">Do you wish to continue? <span class="token punctuation">(</span>yes/no<span class="token punctuation">)</span>: <span class="token function">yes</span>
</span><span class="code-line">Writing<span class="token punctuation">..</span>.
</span><span class="code-line"><span class="token number">4096</span> bytes <span class="token punctuation">(</span><span class="token number">4.1</span> kB, <span class="token number">4.0</span> KiB<span class="token punctuation">)</span> copied, <span class="token number">17</span> s, <span class="token number">0.2</span> kB/s
</span><span class="code-line"><span class="token number">8</span>+0 records <span class="token keyword">in</span>
</span><span class="code-line"><span class="token number">8</span>+0 records out
</span><span class="code-line"><span class="token number">4096</span> bytes <span class="token punctuation">(</span><span class="token number">4.1</span> kB, <span class="token number">4.0</span> KiB<span class="token punctuation">)</span> copied, <span class="token number">16.6287</span> s, <span class="token number">0.2</span> kB/s
</span><span class="code-line">Closing EEPROM Device.
</span><span class="code-line">Done.
</span><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">sudo</span> ./eepflash.sh <span class="token parameter variable">-w</span> <span class="token parameter variable">-f</span><span class="token operator">=</span>klipper-fan-hat-with-dt.eep <span class="token parameter variable">-t</span><span class="token operator">=</span>24c32
</span><span class="code-line">This will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.
</span><span class="code-line">This script comes with ABSOLUTELY no warranty. Continue only <span class="token keyword">if</span> you know what you are doing.
</span><span class="code-line highlight-line">Do you wish to continue? <span class="token punctuation">(</span>yes/no<span class="token punctuation">)</span>: <span class="token function">yes</span>
</span><span class="code-line">Writing<span class="token punctuation">..</span>.
</span><span class="code-line"><span class="token number">512</span> bytes copied, <span class="token number">2</span> s, <span class="token number">0.3</span> kB/s
</span><span class="code-line"><span class="token number">1</span>+1 records <span class="token keyword">in</span>
</span><span class="code-line"><span class="token number">1</span>+1 records out
</span><span class="code-line"><span class="token number">636</span> bytes copied, <span class="token number">2.40116</span> s, <span class="token number">0.3</span> kB/s
</span><span class="code-line">Closing EEPROM Device.
</span><span class="code-line">Done.
</span></code></pre><p>We can check that I2C and SPI is enabled by switching off I2C using <code>raspi-config</code> <a href="/projects/printer-klipper-fan-hat#enable-i2c">the same way we enabled it</a> except clicking <code>No</code> when prompted to enable.</p><p>After another restart you will be able to see the devices <code>/dev/i2c-1</code>, and <code>/dev/spidev0.0</code> and <code>/dev/spidev0.1</code> only when the hat EEPROM is connected.</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~ $ <span class="token function">ls</span> /dev
</span><span class="code-line">autofs         dma_heap   i2c-1    loop4         mmcblk0    ram1   ram5     spidev0.0  tty12  tty21  tty30  tty4   tty49  tty58  ttyAMA0    vcs1   vcsa4     vcsu6    video20
</span><span class="code-line">block          dri        i2c-2    loop5         mmcblk0p1  ram10  ram6     spidev0.1  tty13  tty22  tty31  tty40  tty5   tty59  ttyprintk  vcs2   vcsa5     vhci     video21
</span><span class="code-line">btrfs-control  fd         initctl  loop6         mmcblk0p2  ram11  ram7     stderr     tty14  tty23  tty32  tty41  tty50  tty6   uhid       vcs3   vcsa6     video10  video22
</span><span class="code-line">bus            full       input    loop7         mqueue     ram12  ram8     stdin      tty15  tty24  tty33  tty42  tty51  tty60  uinput     vcs4   vcsm-cma  video11  video23
</span><span class="code-line">cachefiles     fuse       kmsg     loop-control  net        ram13  ram9     stdout     tty16  tty25  tty34  tty43  tty52  tty61  urandom    vcs5   vcsu      video12  video31
</span><span class="code-line">cec0           gpiochip0  log      mapper        null       ram14  random   <span class="token function">tty</span>        tty17  tty26  tty35  tty44  tty53  tty62  v4l        vcs6   vcsu1     video13  watchdog
</span><span class="code-line">char           gpiochip1  loop0    media0        ppp        ram15  rfkill   tty0       tty18  tty27  tty36  tty45  tty54  tty63  vchiq      vcsa   vcsu2     video14  watchdog0
</span><span class="code-line">console        gpiochip2  loop1    media1        ptmx       ram2   serial1  tty1       tty19  tty28  tty37  tty46  tty55  tty7   vcio       vcsa1  vcsu3     video15  zero
</span><span class="code-line">cuse           gpiomem    loop2    media2        pts        ram3   shm      tty10      tty2   tty29  tty38  tty47  tty56  tty8   vc-mem     vcsa2  vcsu4     video16
</span><span class="code-line">disk           hwrng      loop3    mem           ram0       ram4   snd      tty11      tty20  tty3   tty39  tty48  tty57  tty9   vcs        vcsa3  vcsu5     video18
</span></code></pre><h3 id="embed-klipper-config-in-eeprom">Embed Klipper config in EEPROM</h3><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">nano</span> klipper-fan-hat.cfg
</span></code></pre><p>Update the contents with the <a href="https://github.com/mikepthomas/Klipper-Fan-Hat/blob/main/Software/klipper-fan-hat.cfg" rel="noopener noreferrer" target="_blank">Klipper config source file from the Repository</a>.</p><p>Save the file, and embed the config file into the EEPROM image</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ ./eepmake eeprom_settings.txt klipper-fan-hat-with-dt.eep klipper-fan-hat.dtb <span class="token parameter variable">-c</span> klipper-fan-hat.cfg
</span><span class="code-line">Opening <span class="token function">file</span> eeprom_settings.txt <span class="token keyword">for</span> <span class="token builtin class-name">read</span>
</span><span class="code-line"><span class="token assign-left variable">UUID</span><span class="token operator">=</span>62ed7b88-3e38-4958-a397-5271702f3386
</span><span class="code-line">Done reading
</span><span class="code-line">Opening DT <span class="token function">file</span> klipper-fan-hat.dtb <span class="token keyword">for</span> <span class="token builtin class-name">read</span>
</span><span class="code-line">Adding <span class="token number">411</span> bytes of DT data
</span><span class="code-line">Opening custom data <span class="token function">file</span> klipper-fan-hat.cfg <span class="token keyword">for</span> <span class="token builtin class-name">read</span>
</span><span class="code-line">Adding <span class="token number">3450</span> bytes of custom data
</span><span class="code-line">Writing out<span class="token punctuation">..</span>.
</span><span class="code-line">Writing out DT<span class="token punctuation">..</span>.
</span><span class="code-line">Done.
</span></code></pre><p>...then flash the EEPROM</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">sudo</span> ./eepflash.sh <span class="token parameter variable">-w</span> <span class="token parameter variable">-f</span><span class="token operator">=</span>blank.eep <span class="token parameter variable">-t</span><span class="token operator">=</span>24c32
</span><span class="code-line">This will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.
</span><span class="code-line">This script comes with ABSOLUTELY no warranty. Continue only <span class="token keyword">if</span> you know what you are doing.
</span><span class="code-line highlight-line">Do you wish to continue? <span class="token punctuation">(</span>yes/no<span class="token punctuation">)</span>: <span class="token function">yes</span>
</span><span class="code-line">Writing<span class="token punctuation">..</span>.
</span><span class="code-line"><span class="token number">4096</span> bytes <span class="token punctuation">(</span><span class="token number">4.1</span> kB, <span class="token number">4.0</span> KiB<span class="token punctuation">)</span> copied, <span class="token number">17</span> s, <span class="token number">0.2</span> kB/s
</span><span class="code-line"><span class="token number">8</span>+0 records <span class="token keyword">in</span>
</span><span class="code-line"><span class="token number">8</span>+0 records out
</span><span class="code-line"><span class="token number">4096</span> bytes <span class="token punctuation">(</span><span class="token number">4.1</span> kB, <span class="token number">4.0</span> KiB<span class="token punctuation">)</span> copied, <span class="token number">16.5953</span> s, <span class="token number">0.2</span> kB/s
</span><span class="code-line">Closing EEPROM Device.
</span><span class="code-line">Done.
</span><span class="code-line highlight-line">pi@raspberrypi:~/hats/eepromutils $ <span class="token function">sudo</span> ./eepflash.sh <span class="token parameter variable">-w</span> <span class="token parameter variable">-f</span><span class="token operator">=</span>klipper-fan-hat-with-dt.eep <span class="token parameter variable">-t</span><span class="token operator">=</span>24c32
</span><span class="code-line">This will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.
</span><span class="code-line">This script comes with ABSOLUTELY no warranty. Continue only <span class="token keyword">if</span> you know what you are doing.
</span><span class="code-line highlight-line">Do you wish to continue? <span class="token punctuation">(</span>yes/no<span class="token punctuation">)</span>: <span class="token function">yes</span>
</span><span class="code-line">Writing<span class="token punctuation">..</span>.
</span><span class="code-line"><span class="token number">4096</span> bytes <span class="token punctuation">(</span><span class="token number">4.1</span> kB, <span class="token number">4.0</span> KiB<span class="token punctuation">)</span> copied, <span class="token number">19</span> s, <span class="token number">0.2</span> kB/s
</span><span class="code-line"><span class="token number">8</span>+0 records <span class="token keyword">in</span>
</span><span class="code-line"><span class="token number">8</span>+0 records out
</span><span class="code-line"><span class="token number">4096</span> bytes <span class="token punctuation">(</span><span class="token number">4.1</span> kB, <span class="token number">4.0</span> KiB<span class="token punctuation">)</span> copied, <span class="token number">19.0053</span> s, <span class="token number">0.2</span> kB/s
</span><span class="code-line">Closing EEPROM Device.
</span><span class="code-line">Done.
</span></code></pre><p>Restart the Pi and we can then <a href="/projects/printer-klipper-fan-hat#remaining-configuration">copy the config out of the device tree into the klipper config directory</a>.</p><p><span style="opacity:0"><img alt="Flashing an EEPROM with a Raspberry Pi" loading="lazy" width="1280" height="960" decoding="async" data-nimg="1" class="img-fluid img-thumbnail" style="color:transparent" src="/assets/blog/printer-klipper-fan-hat/eeprom-connection-to-rpi.jpg"/></span></p><h2 id="klipper-setup">Klipper Setup</h2><p>To set up Klipper on a Raspberry Pi using the same Pi as secondary mcu, you can follow the steps in the <a href="/projects/printer-klipper-firmware#rpi-microcontroller">RPi microcontroller section of my Klipper Firmware setup page</a>.</p><h3 id="remaining-configuration">Remaining configuration</h3><p>Once you have the RPi microcontroller set up, you can copy the config from the EEPROM chip of the hat into the Klipper config directory, using the following command:</p><pre class="language-sh"><code class="language-sh code-highlight"><span class="code-line highlight-line"><span class="token function">cat</span> /proc/device-tree/hat/custom_1 <span class="token operator">&gt;</span> ~/printer_data/config/klipper-fan-hat.cfg
</span></code></pre></div><div class="col-lg-4"><div class="blog_sidebar__nmDWW position-sticky"><div class="p-4 mb-3 bg-light rounded"><h5>Elsewhere</h5><ul><li><a href="/projects/printer">Anet A8</a></li><li><a href="/projects/printer-rook">Rook 2020</a></li><li><a href="/projects/printer-voron-0.2">Voron 0.2</a></li><li><a href="/projects/printer-voron-1.8">Voron 1.8</a></li><li><a href="/projects/printer-voron-2.4">Voron 2.4</a></li><li><a href="/projects/printer-polyformer">Polyformer</a></li><li><a href="/projects/3d-lab-print-piper-cub">3D LabPrint Piper Cub</a></li><li><a href="/projects/3d-sets-landy">3D Sets Landy</a></li><li><a href="/projects/openrc-f1">OpenRC F1</a></li><li><a href="/projects/openrc-truggy">OpenRC Truggy</a></li><li><a href="/projects/openrc-mini-quad">OpenRC Mini Quad</a></li><li><a href="/projects/knick-knacks">Knick Knacks</a></li><li><a href="/projects/fallout-wasteland-warfare">Fallout: Wasteland Warfare</a></li><li><a href="/projects/guitar">Guitar</a></li><li><a href="/projects/eurorack-modular-synth">Eurorack Modular Synth</a></li><li><a href="/projects/printer-klipper-fan-hat">Klipper Fan Hat</a></li><li><a href="/projects/homelab">Homelab</a></li><li><a href="/projects/cameras">Cameras</a></li><li><a href="/projects/horology">Horology</a></li></ul><h5>External Links</h5><ul><li><a href="https://github.com/timmit99/Klipper-Expander" rel="noopener noreferrer" target="_blank">https://github.com/timmit99/Klipper-Expander<!-- --> <svg data-prefix="fas" data-icon="link" class="svg-inline--fa fa-link" role="img" viewBox="0 0 576 512" aria-hidden="true"><path fill="currentColor" d="M419.5 96c-16.6 0-32.7 4.5-46.8 12.7-15.8-16-34.2-29.4-54.5-39.5 28.2-24 64.1-37.2 101.3-37.2 86.4 0 156.5 70 156.5 156.5 0 41.5-16.5 81.3-45.8 110.6l-71.1 71.1c-29.3 29.3-69.1 45.8-110.6 45.8-86.4 0-156.5-70-156.5-156.5 0-1.5 0-3 .1-4.5 .5-17.7 15.2-31.6 32.9-31.1s31.6 15.2 31.1 32.9c0 .9 0 1.8 0 2.6 0 51.1 41.4 92.5 92.5 92.5 24.5 0 48-9.7 65.4-27.1l71.1-71.1c17.3-17.3 27.1-40.9 27.1-65.4 0-51.1-41.4-92.5-92.5-92.5zM275.2 173.3c-1.9-.8-3.8-1.9-5.5-3.1-12.6-6.5-27-10.2-42.1-10.2-24.5 0-48 9.7-65.4 27.1L91.1 258.2c-17.3 17.3-27.1 40.9-27.1 65.4 0 51.1 41.4 92.5 92.5 92.5 16.5 0 32.6-4.4 46.7-12.6 15.8 16 34.2 29.4 54.6 39.5-28.2 23.9-64 37.2-101.3 37.2-86.4 0-156.5-70-156.5-156.5 0-41.5 16.5-81.3 45.8-110.6l71.1-71.1c29.3-29.3 69.1-45.8 110.6-45.8 86.6 0 156.5 70.6 156.5 156.9 0 1.3 0 2.6 0 3.9-.4 17.7-15.1 31.6-32.8 31.2s-31.6-15.1-31.2-32.8c0-.8 0-1.5 0-2.3 0-33.7-18-63.3-44.8-79.6z"></path></svg></a></li></ul></div></div></div></div></div></article></div></main></div><div class="container"><footer class="d-flex flex-wrap py-3 border-top text-muted"><div class="d-flex align-items-center col">© 2016-<!-- -->2025<!-- --> Mike Thomas, All rights reserved.</div><div class="d-flex justify-content-end col"><a href="/projects/printer-klipper-fan-hat#__next">Back to top</a></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"printer-klipper-fan-hat","related":[],"external":["https://github.com/timmit99/Klipper-Expander"],"title":"Klipper Fan Hat","heading":"Creating a Printed Circuit Board to control fans in Klipper","date":"2023-03-21T00:00:00.000Z","preview":"/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-hero.jpg","author":{"name":"Mike Thomas","picture":"/assets/authors/mike.jpg"},"description":"Making a Raspberry Pi Hat based on the Klipper Expander, to control additional fans using the Pi as a Secondary MCU in Klipper Firmware, the Klipper Fan Hat.","tags":["Printed Circuit Board","Raspberry Pi"],"categories":[],"keywords":["Klipper","Klipper Expander","Klipper Fan Hat"],"promoted":false,"content":"\n# Table of contents\n\n# What is the Klipper Fan Hat?\n\nI wanted to explore making a Raspberry Pi Hat based on [Tim Abraham's Klipper Expander](https://github.com/timmit99/Klipper-Expander) to control additional fans using the [Raspberry Pi as a Secondary MCU in Klipper Firmware](https://www.klipper3d.org/RPi_microcontroller.html).\n\n# What about the Klipper Expander?\n\nThe Klipper Expander is designed to add 4 additional Mosfet outputs, 2 thermistor inputs, a Neopixel output, a GPIO Header and an I2C header that can be added as a secondary Klipper MCU. The Klipper Fan Hat is supposed to be a re-imagining of this, which can be attached on top of the Raspberry Pi that is used as the Klipper Host.\n\nThe Klipper Fan Hat is not supposed to be a replacement for the Klipper Expander, the Klipper expander can handle more current as it has wider PCB tracks than this PCB. Therefore the Klipper Fan Hat should only be used for lower current devices such as fans. Also, the Klipper Fan Hat does not support Neopixels due to space constraints of fitting it within the footprint of a Raspberry Pi Hat.\n\nKlipper Fan Hat features:\n\n- SKR Pico compatible input for powering the Pi and Serial communication\n- 5 Mosfet outputs (with 2 pin JST-XH connectors standard on most fans used on 3D printers)\n- Voltage selector jumpers to power each fan from either 5V or VCC supplied by screw terminal\n- I2C and 1-Wire and SPI headers for connecting accesories to the Raspberry Pi\n- ~2 thermistor inputs~ (removed, see [Testing Section](#testing) to find out why)\n- 2 headers connected to General Purpose GPIO pins for accesories such as Filament Run Out Sensors\n\n# Printed Circuit Board\n\nThe PCB (printed circuit board) was designed in [KiCad 7](https://www.kicad.org/) and I have created a [repository on my GitHub](https://github.com/mikepthomas/Klipper-Fan-Hat) with the design files and Gerber files.\n\nTwo versions of the board have been produced:\n\n- [Pre-release Version 1](https://github.com/mikepthomas/Klipper-Fan-Hat/releases/tag/v1.0)\n- [Release Version 2](https://github.com/mikepthomas/Klipper-Fan-Hat/releases/tag/v2.0)\n\nI used [PCBWay](https://pcbway.com/) to produce the PCBs.\n\n![3D render of the front of the Klipper Fan Hat](/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-front.jpg)\n\nAlthough currently untested, the main branch contains the updated version of the board, V2, with a few revisions to fix some bugs that were found when testing the first version of the board.\n\n![3D render of the back of the Klipper Fan Hat](/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-back.jpg)\n\n# Parts Required\n\nThe reference numbers in the notes field refer to the parts required marked on the silkscreen and [can be seen in the interactive BOM](https://klipper-fan-hat.mikethomas.info/).\n\n## Fasteners\n\n| Item                | Quantity | Received | Notes                                              |\n| ------------------- | -------- | -------- | -------------------------------------------------- |\n| M2.5x6 BHCS         | 4        | 50       | To mount the hat to the Raspberry Pi               |\n| M2.5x14 BHCS        | 4        | 10       | To mount the Fan                                   |\n| M2.5 Nut            | 4        | 50       | To mount the Fan                                   |\n| M2.5 Brass Standoff | 4        | 16       | To stop the fan inputs shorting on the HDMI Socket |\n\n## Connectors\n\n| Item                              | Quantity | Received           | Notes                           |\n| --------------------------------- | -------- | ------------------ | ------------------------------- |\n| 2 Pin JST-XH Header               | 5        | 20                 | FAN1-FAN5                       |\n| 3 Pin JST-XH Header               | 1        | 20                 | J4                              |\n| 4 Pin JST-XH Header               | 1        | 20                 | J3                              |\n| 5 Pin JST-XH Header               | 1        | 20                 | J2                              |\n| 40 Pin Raspberry Pi Header        | 1        | 7                  | J8                              |\n| Dupont Pin Headers                | 41 Pins  | 10 x 40 pin strips | J7, JP1-JP5, WP1, GPIO20-GPIO25 |\n| Jumper Cap 2.54mm                 | 6        | 109                | JP1-JP5, WP1                    |\n| KF301 Screw Terminal (5mm pitch)  | 1        | 10                 | J1                              |\n| PCB Panel Mount Blade Fuse Holder | 1        | 10                 | F1                              |\n\n## SMD Components\n\n| Item                                    | Quantity | Received | Notes                  |\n| --------------------------------------- | -------- | -------- | ---------------------- |\n| 100nF Capacitor (1206 Package)          | 1        | 20       | C1                     |\n| 100Ω Resistor (1206 Package)            | 5        | 123      | R7, R9, R11, R13, R15  |\n| 1kΩ Resistor (1206 Package)             | 1        | 127      | R1                     |\n| 3.9kΩ Resistor (1206 Package)           | 2        | 112      | R2-R3                  |\n| 4.7kΩ Resistor (1206 Package)           | 7        | 103      | R4, R17-R22            |\n| 10kΩ Resistor (1206 Package)            | 5        | 111      | R8, R10, R12, R14, R16 |\n| LED Red (1206 Package)                  | 7        | 105      | D1-D7                  |\n| IRLML6344-TRPBF Mosfet (SOT-23 Package) | 5        | 100      | Q1-Q5                  |\n\n## Misc\n\n| Item                       | Quantity | Received | Notes                                                                   |\n| -------------------------- | -------- | -------- | ----------------------------------------------------------------------- |\n| 2510 Axial Fan             | 1        | 2        |                                                                         |\n| CAT24C32 EEPROM            | 1        | 15       | U1                                                                      |\n| DIP-8 Socket               | 1        | 20       | Not required, but makes switching EEPROM modules out easier for testing |\n| DS18B20 Temperature Sensor | 1        | 15       |                                                                         |\n\n![Holding a Klipper Fan Hat PCB](/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-in-hand.jpg)\n\n\u003e [!NOTE]\n\u003e Some of the images on this page show Version 1 of the PCB, It was originally called the `Klipper Expander Hat` however I have subsequently renamed it to `Klipper Fan Hat` as decided on the [Voron Discord](https://discord.com/channels/460117602945990666/540528535262068739/1090833386421112933) this was so that should not be confused with the `Klipper Expander`.\n\n# Assembly and Testing\n\nAt present assembly testing has only been done with Version 1 of the Klipper Fan hat.\n\n## Assembly\n\nExcuse the messy soldering, this is the first time I have tried to solder Surface Mount Device (SMD) components, and the pads are TINY, I'm probably going to need to invest in a TS100 (...and provides an excuse to buy a shiny new toy).\n\n![An assembled Klipper Fan Hat](/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-assembled.jpg)\n\nThe first time powering the Hat up, I connected the Mosfets to 5V from the Raspberry Pi USB input. All 5 Fan output LEDs lit up which made me happy, however, this happiness was short lived, as I unfortunately found a major design flaw in my design...\n\n## Testing\n\nI used one of my abused Raspberry Pis that I did not mind if I destroyed by releasing its \"Magic Smoke\" whilst testing the board. This is a Raspberry Pi 3 that unfortunately has lost its ability to talk to Wifi or Bluetooth devices, hence the USB wifi module you can see in any pictures.\n\nI have connected a 12V power supply to VCC for testing, however it should also work for 24V. I switched the power selector jumpers for the Fan mosfets to VCC and tried to switch 12V Fans which also worked succesfully. I have also connected a mini OLED display to the I2C bus and managed to get it to output the default Klipper display.\n\n![Testing the Klipper Fan Hat](/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-testing.jpg)\n\nI have yet to test the Serial port; it just passes the connections directly to the GPIO pins the same way as the I2C port does, so I am pretty sure it will work.\n\nNow to the major design flaw - I neglected to check if the Raspberry Pi is capable of analog input (spoiler - it's not) I have looked into adding an Analog to Digital Converter (ADC), however it will take up quite a bit of space on the board and I am unsure if I could get it to work with Klipper. I have therefore opted to remove the thermistor ports in favour of 2 General Purpose Input/Output connectors for connecting items such as Filament Runout Sensors instead.\n\n![Testing a 1-wire temperature sensor](/assets/blog/printer-klipper-fan-hat/1-wire-temp-sensor.jpg)\n\nIf a temperature sensor is required, I have tested a couple of different DS18B20 temperature sensors, they connect to the 1-wire port and are be [compatable with Klipper](https://www.klipper3d.org/Config_Reference.html#ds18b20-temperature-sensor). It is also possible to connect a HTU21D Temperature and Humidity sensor to the I2C port that is also [compatible with Klipper](https://www.klipper3d.org/Config_Reference.html#htu21d-sensor).\n\nI also have a DHT11 temperature sensor to test on the 1-Wire port. This is not currently compatible with Klipper, but could be used with a [Python script running directly on the Pi](https://www.circuitbasics.com/how-to-set-up-the-dht11-humidity-sensor-on-the-raspberry-pi/).\n\nAfter further testing, I have noticed I have used some incorrect resistor values in some places, I have now updated these to the correct values. I have also removed the decoupling capacitors from the thermistor ports and changed the pull up resistors to 3.9kΩ so that I can repurpose the non working thermistor ports as GPIO the same way I have added into V2.\n\nThese have been tested by connecting the 1-wire and the two GPIO pins to a [rotary encoder](https://github.com/mikepthomas/Klipper-Fan-Hat/blob/main/Software/klipper-fan-hat.cfg#L67-L69), and I have also tested a microswitch acting as a [filament runout sensor](https://github.com/mikepthomas/Klipper-Fan-Hat/blob/main/Software/klipper-fan-hat.cfg#L115-L118). Both of which worked perfectly and I have added example configuration sections to the Klipper config file.\n\n![Testing a rotary encoder](/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-rotary-encoder.jpg)\n\n## The Road to V2\n\n![Holding Version 2 of the PCB](/assets/blog/printer-klipper-fan-hat/klipper-fan-hat-version-2.jpg)\n\nAfter my testing I identified a few improvements that I have now made and are available in the master branch:\n\n- Rename to Klipper Fan Hat\n- Increase the thickness of the power delivery tracks\n- Increase the thickness of the mosfet tracks\n- Covered entire bottom side with ground plane\n- Move the EEPROM decoupling capacitor closer to the chip\n- Add pull up resistor to the 1-Wire pin\n- Move Fan 5 power selector header to the other side of the connector to allow space for fan wiring\n- Add missing component markings for power LED, it's resistor and power input screw terminal\n- Add pin markings to the silkscreen for Power, Serial, SPI and I2C\n- Replace non-working thermistor inputs with GPIO connectors\n- Switch orientation of Fan 1-4 resistors so that it does't matter if they are bridged when soldering\n- Added a status LED that can be controlled by the Klipper host\n- On Board DS18B20 Temperature Sensor\n\nI have received the printed circuit boards for Version 2 of the fan hat however I have not yet assembled one. I have however, purchased a cheap [Hot Air Soldering station](https://www.amazon.co.uk/dp/B0C5M9Q86V) to hopefully put some together a little more professionally with the aim to eventually sell on the [pcb_party channel on the Voron Discord](https://discord.com/channels/460117602945990666/981274124850724965) so watch this space if you would like to puchase one.\n\n# Flash Hat EEPROM\n\n## Install git\n\nWe will need to install Git so we can check out the Raspberry Pi Hats Repository as it is not included in the base Raspberry Pi OS image.\n\n```sh {1, 3, 16}\npi@raspberrypi:~ $ sudo apt update\n...\npi@raspberrypi:~ $ sudo apt install git\nReading package lists... Done\nBuilding dependency tree... Done\nReading state information... Done\nThe following additional packages will be installed:\n  git-man liberror-perl\nSuggested packages:\n  git-daemon-run | git-daemon-sysvinit git-doc git-el git-email git-gui gitk gitweb git-cvs git-mediawiki git-svn\nThe following NEW packages will be installed:\n  git git-man liberror-perl\n0 upgraded, 3 newly installed, 0 to remove and 13 not upgraded.\nNeed to get 6,533 kB/6,564 kB of archives.\nAfter this operation, 33.1 MB of additional disk space will be used.\nDo you want to continue? [Y/n] y\n...\nSetting up git (1:2.30.2-1+deb11u2) ...\n```\n\n## Clone Hats Git Repository\n\nNext we need to get the code from the Raspberry Pi Hats Repository.\n\n```sh {1}\npi@raspberrypi:~ $ git clone https://github.com/raspberrypi/hats.git\nCloning into 'hats'...\nremote: Enumerating objects: 624, done.\nremote: Counting objects: 100% (154/154), done.\nremote: Compressing objects: 100% (65/65), done.\nremote: Total 624 (delta 100), reused 131 (delta 89), pack-reused 470\nReceiving objects: 100% (624/624), 326.80 KiB | 1.56 MiB/s, done.\nResolving deltas: 100% (366/366), done.\n```\n\n## Make EEPROM Utils\n\nOnce we have cloned the repository we need to compile the tools to make the EEPROM image and flash it to the chip.\n\n```sh {1-2, 5}\npi@raspberrypi:~ $ cd hats/eepromutils/\npi@raspberrypi:~/hats/eepromutils $ make -j4\ncc -Wall -Wextra eepmake.c -o eepmake\ncc -Wall -Wextra eepdump.c -o eepdump\npi@raspberrypi:~/hats/eepromutils $ ls\neepdump  eepdump.c  eepflash.sh  eepmake  eepmake.c  eeprom_settings.txt  eeptypes.h  Makefile  README.md\n```\n\n## Enable I2C\n\nTo communicate with the EEPROM chip we need to enable the I2C interface.\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ sudo raspi-config\n```\n\nSelect:\ninterfacing Options -\u003e I2C -\u003e Yes -\u003e ok -\u003e Finish\n\nWe will then need to reboot the Raspberry Pi to enable.\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ sudo reboot\n```\n\nWhen finished restarting, we will need to install the `i2c-tools` package, log in and run:\n\n```sh {1, 14}\npi@raspberrypi:~ $ sudo apt install i2c-tools\nReading package lists... Done\nBuilding dependency tree... Done\nReading state information... Done\nThe following additional packages will be installed:\n  libi2c0 read-edid\nSuggested packages:\n  libi2c-dev python-smbus\nThe following NEW packages will be installed:\n  i2c-tools libi2c0 read-edid\n0 upgraded, 3 newly installed, 0 to remove and 13 not upgraded.\nNeed to get 103 kB of archives.\nAfter this operation, 359 kB of additional disk space will be used.\nDo you want to continue? [Y/n] y\n...\nSetting up i2c-tools (4.2-1+b1) ...\n```\n\n## Connect EEPROM\n\nThe Raspberry Pi should be powered off before making any connections to the GPIO pins.\n\n```sh {1}\npi@raspberrypi:~ $ sudo halt\n```\n\nWe will then need to connect the EEPROM chip as per the following diagram, I did not add the RGB LED or its resistors as I just wanted to flash the EEPROM.\n\n![EEPROM Connection Diagram](https://rpi-magazines.s3-eu-west-1.amazonaws.com/magpi/legacy-assets/2016/03/eeprom-hat-led_bb.jpg)\n\n\u003e Image \u0026copy; 2016 [The MagPi Magazine](https://magpi.raspberrypi.com/articles/make-your-own-hat)\n\nI did not have any 3.9kΩ resistors available but I used 4.7kΩ without any problems.\n\nSwitch the Raspberry Pi back on.\n\n## Test EEPROM is Connected\n\nIf when we try to detect the EEPROM we get a 'No such file or directory' error such as...\n\n```sh {1}\npi@raspberrypi:~ $ i2cdetect -y 9\nError: Could not open file `/dev/i2c-9' or `/dev/i2c/9': No such file or directory\n```\n\n...run the following command as explained in the [EEPROM Utils Docs](https://github.com/raspberrypi/hats/tree/master/eepromutils).\n\n```sh {1}\npi@raspberrypi:~ $ sudo dtoverlay i2c-gpio i2c_gpio_sda=0 i2c_gpio_scl=1 bus=9\n```\n\nYou should then be able to see the EEPROM Chip at address 50:\n\n```sh {1}\npi@raspberrypi:~ $ i2cdetect -y 9\n     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f\n00:                         -- -- -- -- -- -- -- --\n10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n50: 50 -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --\n70: -- -- -- -- -- -- -- --\n```\n\n## Zero EEPROM\n\nThe Recommended EEPROM in the [Design Guide](https://github.com/raspberrypi/hats/blob/master/designguide.md) at the time of writing is CAT24C32 which is 32kbit (4kbyte).\n\nAs we don't know the state of the EEPROM it is best to clear it by setting it all to zeros.\nIf your EEPROM is a different size you will need to set `count` to the value of kbyte of your chip.\n\nMake a blank image using dd:\n\n```sh {1-2}\npi@raspberrypi:~ $ cd hats/eepromutils/\npi@raspberrypi:~/hats/eepromutils $ dd if=/dev/zero ibs=1k count=4 of=blank.eep\n4+0 records in\n8+0 records out\n4096 bytes (4.1 kB, 4.0 KiB) copied, 0.000941149 s, 4.4 MB/s\n```\n\nVerify it is actually blank with `hexdump`...\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ hexdump blank.eep\n0000000 0000 0000 0000 0000 0000 0000 0000 0000\n*\n0001000\n```\n\n...and flash it to the chip.\n\n```sh {1, 4}\npi@raspberrypi:~/hats/eepromutils $ sudo ./eepflash.sh -w -f=blank.eep -t=24c32\nThis will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.\nThis script comes with ABSOLUTELY no warranty. Continue only if you know what you are doing.\nDo you wish to continue? (yes/no): yes\nWriting...\n4096 bytes (4.1 kB, 4.0 KiB) copied, 17 s, 0.2 kB/s\n8+0 records in\n8+0 records out\n4096 bytes (4.1 kB, 4.0 KiB) copied, 16.7208 s, 0.2 kB/s\nClosing EEPROM Device.\nDone.\n```\n\n## Flash EEPROM\n\nNow that we have a blank EEPROM chip, we can configure and flash the Hat EEPROM image to it.\nOpen the `eeprom_settings.txt` file:\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ nano eeprom_settings.txt\n```\n\nUpdate the contents with the [Klipper Fan Hat settings file from the Repository](https://github.com/mikepthomas/Klipper-Fan-Hat/blob/main/EEPROM/eeprom_settings.txt).\n\nSave and close the file, and then we can make the EEPROM image...\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ ./eepmake eeprom_settings.txt klipper-fan-hat.eep\nOpening file eeprom_settings.txt for read\nUUID=fef562f0-9e28-4453-88c2-c073303e6ab2\nDone reading\nWriting out...\nDone.\n```\n\n...and flash it to the chip.\n\n```sh {1, 4}\npi@raspberrypi:~/hats/eepromutils $ sudo ./eepflash.sh -w -f=klipper-fan-hat.eep -t=24c32\nThis will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.\nThis script comes with ABSOLUTELY no warranty. Continue only if you know what you are doing.\nDo you wish to continue? (yes/no): yes\nWriting...\n0+1 records in\n0+1 records out\n215 bytes copied, 0.788403 s, 0.3 kB/s\nClosing EEPROM Device.\nDone.\n```\n\n## Test EEPROM\n\nThe Hat EEPROM is read on system boot so we will need to reboot the Pi before we can test it:\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ sudo reboot\n```\n\nWe can then read the data using the device tree:\n\n```sh {1-2, 4, 6, 8, 10, 12, 14}\npi@raspberrypi:~ $ cd /proc/device-tree/hat/\npi@raspberrypi:/proc/device-tree/hat $ ls\ncustom_0  name  product  product_id  product_ver  uuid  vendor\npi@raspberrypi:/proc/device-tree/hat $ more name\nhat\npi@raspberrypi:/proc/device-tree/hat $ more vendor\nVoron Design\npi@raspberrypi:/proc/device-tree/hat $ more product\nKlipper Fan Hat\npi@raspberrypi:/proc/device-tree/hat $ more product_id\n0x4b46\npi@raspberrypi:/proc/device-tree/hat $ more product_ver\n0x0002\npi@raspberrypi:/proc/device-tree/hat $ more uuid\nfef562f0-9e28-4453-88c2-c073303e6ab2\n```\n\n## Enable I2C and SPI Automatically\n\nTo allow the hat to automatically enable I2C and SPI we will create a device tree overlay and embed it into the EEPROM. The Raspberry Pi will then enable this at boot time.\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ nano klipper-fan-hat.dts\n```\n\nUpdate the contents with the [Klipper Fan Hat device tree source file from the Repository](https://github.com/mikepthomas/Klipper-Fan-Hat/blob/main/EEPROM/klipper-fan-hat.dts).\n\nSave the file, compile the binary and set the correct permissions to the output file:\n\n```sh {1-2}\npi@raspberrypi:~/hats/eepromutils $ sudo dtc -@ -I dts -O dtb -o klipper-fan-hat.dtb klipper-fan-hat.dts\npi@raspberrypi:~/hats/eepromutils $ sudo chown pi:pi klipper-fan-hat.dtb\n```\n\nYou may need to install the `device-tree-compiler` package if you get any errors running the previous command, however, it was already installed in the version of Raspberry Pi OS that I was using.\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ sudo apt-get install device-tree-compiler\n```\n\nWe can then embed the device tree binary into the flash file...\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ ./eepmake eeprom_settings.txt klipper-fan-hat-with-dt.eep klipper-fan-hat.dtb\nOpening file eeprom_settings.txt for read\nUUID=967cd2a4-9c61-4397-ae2e-5184a7f2b7de\nDone reading\nOpening DT file klipper-fan-hat.dtb for read\nAdding 411 bytes of DT data\nWriting out...\nWriting out DT...\nDone.\n```\n\n...and flash it to the EEPROM the same way we did before:\n\n```sh {1, 4, 12, 15}\npi@raspberrypi:~/hats/eepromutils $ sudo ./eepflash.sh -w -f=blank.eep -t=24c32\nThis will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.\nThis script comes with ABSOLUTELY no warranty. Continue only if you know what you are doing.\nDo you wish to continue? (yes/no): yes\nWriting...\n4096 bytes (4.1 kB, 4.0 KiB) copied, 17 s, 0.2 kB/s\n8+0 records in\n8+0 records out\n4096 bytes (4.1 kB, 4.0 KiB) copied, 16.6287 s, 0.2 kB/s\nClosing EEPROM Device.\nDone.\npi@raspberrypi:~/hats/eepromutils $ sudo ./eepflash.sh -w -f=klipper-fan-hat-with-dt.eep -t=24c32\nThis will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.\nThis script comes with ABSOLUTELY no warranty. Continue only if you know what you are doing.\nDo you wish to continue? (yes/no): yes\nWriting...\n512 bytes copied, 2 s, 0.3 kB/s\n1+1 records in\n1+1 records out\n636 bytes copied, 2.40116 s, 0.3 kB/s\nClosing EEPROM Device.\nDone.\n```\n\nWe can check that I2C and SPI is enabled by switching off I2C using `raspi-config` [the same way we enabled it](#enable-i2c) except clicking `No` when prompted to enable.\n\nAfter another restart you will be able to see the devices `/dev/i2c-1`, and `/dev/spidev0.0` and `/dev/spidev0.1` only when the hat EEPROM is connected.\n\n```sh {1}\npi@raspberrypi:~ $ ls /dev\nautofs         dma_heap   i2c-1    loop4         mmcblk0    ram1   ram5     spidev0.0  tty12  tty21  tty30  tty4   tty49  tty58  ttyAMA0    vcs1   vcsa4     vcsu6    video20\nblock          dri        i2c-2    loop5         mmcblk0p1  ram10  ram6     spidev0.1  tty13  tty22  tty31  tty40  tty5   tty59  ttyprintk  vcs2   vcsa5     vhci     video21\nbtrfs-control  fd         initctl  loop6         mmcblk0p2  ram11  ram7     stderr     tty14  tty23  tty32  tty41  tty50  tty6   uhid       vcs3   vcsa6     video10  video22\nbus            full       input    loop7         mqueue     ram12  ram8     stdin      tty15  tty24  tty33  tty42  tty51  tty60  uinput     vcs4   vcsm-cma  video11  video23\ncachefiles     fuse       kmsg     loop-control  net        ram13  ram9     stdout     tty16  tty25  tty34  tty43  tty52  tty61  urandom    vcs5   vcsu      video12  video31\ncec0           gpiochip0  log      mapper        null       ram14  random   tty        tty17  tty26  tty35  tty44  tty53  tty62  v4l        vcs6   vcsu1     video13  watchdog\nchar           gpiochip1  loop0    media0        ppp        ram15  rfkill   tty0       tty18  tty27  tty36  tty45  tty54  tty63  vchiq      vcsa   vcsu2     video14  watchdog0\nconsole        gpiochip2  loop1    media1        ptmx       ram2   serial1  tty1       tty19  tty28  tty37  tty46  tty55  tty7   vcio       vcsa1  vcsu3     video15  zero\ncuse           gpiomem    loop2    media2        pts        ram3   shm      tty10      tty2   tty29  tty38  tty47  tty56  tty8   vc-mem     vcsa2  vcsu4     video16\ndisk           hwrng      loop3    mem           ram0       ram4   snd      tty11      tty20  tty3   tty39  tty48  tty57  tty9   vcs        vcsa3  vcsu5     video18\n```\n\n## Embed Klipper config in EEPROM\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ nano klipper-fan-hat.cfg\n```\n\nUpdate the contents with the [Klipper config source file from the Repository](https://github.com/mikepthomas/Klipper-Fan-Hat/blob/main/Software/klipper-fan-hat.cfg).\n\nSave the file, and embed the config file into the EEPROM image\n\n```sh {1}\npi@raspberrypi:~/hats/eepromutils $ ./eepmake eeprom_settings.txt klipper-fan-hat-with-dt.eep klipper-fan-hat.dtb -c klipper-fan-hat.cfg\nOpening file eeprom_settings.txt for read\nUUID=62ed7b88-3e38-4958-a397-5271702f3386\nDone reading\nOpening DT file klipper-fan-hat.dtb for read\nAdding 411 bytes of DT data\nOpening custom data file klipper-fan-hat.cfg for read\nAdding 3450 bytes of custom data\nWriting out...\nWriting out DT...\nDone.\n```\n\n...then flash the EEPROM\n\n```sh {1, 4, 12, 15}\npi@raspberrypi:~/hats/eepromutils $ sudo ./eepflash.sh -w -f=blank.eep -t=24c32\nThis will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.\nThis script comes with ABSOLUTELY no warranty. Continue only if you know what you are doing.\nDo you wish to continue? (yes/no): yes\nWriting...\n4096 bytes (4.1 kB, 4.0 KiB) copied, 17 s, 0.2 kB/s\n8+0 records in\n8+0 records out\n4096 bytes (4.1 kB, 4.0 KiB) copied, 16.5953 s, 0.2 kB/s\nClosing EEPROM Device.\nDone.\npi@raspberrypi:~/hats/eepromutils $ sudo ./eepflash.sh -w -f=klipper-fan-hat-with-dt.eep -t=24c32\nThis will attempt to talk to an eeprom at i2c address 0x50. Make sure there is an eeprom at this address.\nThis script comes with ABSOLUTELY no warranty. Continue only if you know what you are doing.\nDo you wish to continue? (yes/no): yes\nWriting...\n4096 bytes (4.1 kB, 4.0 KiB) copied, 19 s, 0.2 kB/s\n8+0 records in\n8+0 records out\n4096 bytes (4.1 kB, 4.0 KiB) copied, 19.0053 s, 0.2 kB/s\nClosing EEPROM Device.\nDone.\n```\n\nRestart the Pi and we can then [copy the config out of the device tree into the klipper config directory](#remaining-configuration).\n\n![Flashing an EEPROM with a Raspberry Pi](/assets/blog/printer-klipper-fan-hat/eeprom-connection-to-rpi.jpg)\n\n# Klipper Setup\n\nTo set up Klipper on a Raspberry Pi using the same Pi as secondary mcu, you can follow the steps in the [RPi microcontroller section of my Klipper Firmware setup page](printer-klipper-firmware#rpi-microcontroller).\n\n## Remaining configuration\n\nOnce you have the RPi microcontroller set up, you can copy the config from the EEPROM chip of the hat into the Klipper config directory, using the following command:\n\n```sh {1}\ncat /proc/device-tree/hat/custom_1 \u003e ~/printer_data/config/klipper-fan-hat.cfg\n```\n","lastmod":"2024-06-03T20:59:33.506Z"},"related":[]},"__N_SSG":true},"page":"/projects/[slug]","query":{"slug":"printer-klipper-fan-hat"},"buildId":"Y5mSgE8YhqnLmiRs80-DT","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>